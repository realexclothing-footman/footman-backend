<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOOTMAN Business Admin - Modern</title>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Maps for location display -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzyphoov_MRg7ELNMbNmyApIVcuz3YPss&callback=initMap" async defer></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Recharts for modern charts -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    <style>
        /* ========== MODERN DESIGN FROM NEW FILE ========== */
        *,:before,:after{--tw-border-spacing-x: 0;--tw-border-spacing-y: 0;--tw-translate-x: 0;--tw-translate-y: 0;--tw-rotate: 0;--tw-skew-x: 0;--tw-skew-y: 0;--tw-scale-x: 1;--tw-scale-y: 1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness: proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width: 0px;--tw-ring-offset-color: #fff;--tw-ring-color: rgb(59 130 246 / .5);--tw-ring-offset-shadow: 0 0 #0000;--tw-ring-shadow: 0 0 #0000;--tw-shadow: 0 0 #0000;--tw-shadow-colored: 0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x: 0;--tw-border-spacing-y: 0;--tw-translate-x: 0;--tw-translate-y: 0;--tw-rotate: 0;--tw-skew-x: 0;--tw-skew-y: 0;--tw-scale-x: 1;--tw-scale-y: 1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness: proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width: 0px;--tw-ring-offset-color: #fff;--tw-ring-color: rgb(59 130 246 / .5);--tw-ring-offset-shadow: 0 0 #0000;--tw-ring-shadow: 0 0 #0000;--tw-shadow: 0 0 #0000;--tw-shadow-colored: 0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }
        
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 160 84% 39%;
            --primary-foreground: 355.7 100% 97.3%;
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96.1%;
            --accent-foreground: 222.2 47.4% 11.2%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 160 84% 39%;
            --radius: .75rem;
        }

        .dark {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 160 84% 39%;
            --primary-foreground: 222.2 47.4% 11.2%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 160 84% 39%;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            border-color: hsl(var(--border));
        }

        body {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ========== MODERN LAYOUT ========== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* ========== MODERN SIDEBAR ========== */
        .sidebar {
            width: 280px;
            background: hsl(var(--card));
            border-right: 1px solid hsl(var(--border));
            padding: 24px 0;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            z-index: 100;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 0 24px 32px;
            border-bottom: 1px solid hsl(var(--border));
            margin-bottom: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, hsl(var(--primary)), #8b5cf6);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3);
        }

        .logo-text h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            color: hsl(var(--foreground));
        }

        .logo-text span {
            font-size: 12px;
            opacity: 0.7;
            color: hsl(var(--muted-foreground));
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: hsl(var(--muted-foreground));
            padding: 0 24px 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 24px;
            color: hsl(var(--foreground));
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            opacity: 0.7;
        }

        .nav-item:hover {
            background: rgba(16, 185, 129, 0.05);
            color: hsl(var(--primary));
            padding-left: 28px;
            opacity: 1;
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(139, 92, 246, 0.1));
            color: hsl(var(--primary));
            border-left: 4px solid hsl(var(--primary));
            opacity: 1;
        }

        .nav-item i {
            width: 20px;
            font-size: 18px;
        }

        .nav-badge {
            margin-left: auto;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            min-width: 24px;
            text-align: center;
            background: hsl(var(--primary) / 0.2);
            color: hsl(var(--primary));
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 24px;
            border-top: 1px solid hsl(var(--border));
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, hsl(var(--primary)), #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            font-size: 16px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: hsl(var(--foreground));
            margin-bottom: 2px;
            font-size: 14px;
        }

        .user-email {
            font-size: 12px;
            color: hsl(var(--muted-foreground));
        }

        /* ========== MODERN TOPBAR ========== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: hsl(var(--background));
        }

        .topbar {
            background: hsl(var(--card)) / 0.8;
            backdrop-filter: blur(10px);
            padding: 0 32px;
            border-bottom: 1px solid hsl(var(--border));
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 72px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 20px;
            color: hsl(var(--foreground));
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
        }

        .menu-toggle:hover {
            background: hsl(var(--muted));
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: hsl(var(--foreground));
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .search-container {
            position: relative;
            width: 300px;
        }

        .search-container i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: hsl(var(--muted-foreground));
        }

        .search-container input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            font-size: 14px;
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            transition: all 0.3s ease;
        }

        .search-container input:focus {
            outline: none;
            border-color: hsl(var(--primary));
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .theme-toggle {
            background: none;
            border: none;
            color: hsl(var(--muted-foreground));
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: hsl(var(--muted));
            color: hsl(var(--primary));
        }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            color: hsl(var(--muted-foreground));
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .notification-btn:hover {
            background: hsl(var(--muted));
            color: hsl(var(--primary));
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            width: 18px;
            height: 18px;
            background: hsl(var(--primary));
            color: white;
            font-size: 10px;
            font-weight: 600;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ========== MODERN CONTENT AREA ========== */
        .content-wrapper {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-subtitle {
            color: hsl(var(--muted-foreground));
            font-size: 16px;
            margin-top: 8px;
        }

        /* ========== MODERN STATS CARDS ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: hsl(var(--card));
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-top: 4px solid hsl(var(--primary));
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, hsl(var(--primary)), #8b5cf6);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            color: white;
            font-size: 24px;
        }

        .stat-content h3 {
            font-size: 14px;
            color: hsl(var(--muted-foreground));
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            color: hsl(var(--foreground));
            margin-bottom: 8px;
            line-height: 1;
        }

        .stat-change {
            font-size: 14px;
            color: hsl(var(--primary));
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* ========== MODERN CHARTS ========== */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .chart-card {
            background: hsl(var(--card));
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: hsl(var(--foreground));
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        /* ========== MODERN DATA TABLES ========== */
        .data-section {
            margin-bottom: 32px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: hsl(var(--foreground));
        }

        .section-actions {
            display: flex;
            gap: 12px;
        }

        .data-card {
            background: hsl(var(--card));
            border-radius: var(--radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .card-header {
            padding: 24px;
            border-bottom: 1px solid hsl(var(--border));
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: hsl(var(--foreground));
        }

        .card-tools {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .filter-select {
            padding: 10px 16px;
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            background: hsl(var(--card));
            font-size: 14px;
            color: hsl(var(--foreground));
            cursor: pointer;
            min-width: 150px;
        }

        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .data-table th {
            background: hsl(var(--muted)) / 0.5;
            padding: 18px 24px;
            text-align: left;
            font-weight: 600;
            color: hsl(var(--muted-foreground));
            border-bottom: 1px solid hsl(var(--border));
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .data-table td {
            padding: 18px 24px;
            border-bottom: 1px solid hsl(var(--border));
            vertical-align: middle;
            font-size: 14px;
            color: hsl(var(--foreground));
        }

        .data-table tr {
            transition: all 0.3s ease;
        }

        .data-table tr:hover {
            background: hsl(var(--muted)) / 0.3;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* ========== MODERN STATUS BADGES ========== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-active { background: #d1fae5; color: #065f46; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-rejected { background: #fee2e2; color: #991b1b; }
        .status-inactive { background: #fee2e2; color: #991b1b; }
        .status-online { background: #d1fae5; color: #065f46; }
        .status-offline { background: #f1f5f9; color: #64748b; }
        .status-completed { background: #dbeafe; color: #1e40af; }
        .status-ongoing { background: #f3e8ff; color: #6b21a8; }

        .dark .status-active { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .dark .status-pending { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .dark .status-rejected { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .dark .status-inactive { background: rgba(100, 116, 139, 0.2); color: #94a3b8; }
        .dark .status-online { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .dark .status-offline { background: rgba(100, 116, 139, 0.2); color: #94a3b8; }
        .dark .status-completed { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .dark .status-ongoing { background: rgba(139, 92, 246, 0.2); color: #c084fc; }

        /* ========== MODERN AVATAR ========== */
        .user-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            background: linear-gradient(135deg, hsl(var(--primary)), #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            flex-shrink: 0;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: hsl(var(--foreground));
            margin-bottom: 2px;
        }

        .user-email {
            font-size: 12px;
            color: hsl(var(--muted-foreground));
        }

        /* ========== MODERN BUTTONS ========== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: hsl(var(--primary));
            color: white;
        }

        .btn-primary:hover {
            background: #059669;
        }

        .btn-secondary {
            background: hsl(var(--secondary));
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid hsl(var(--border));
            color: hsl(var(--foreground));
        }

        .btn-outline:hover {
            border-color: hsl(var(--primary));
            color: hsl(var(--primary));
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* ========== MODAL ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content {
            background: hsl(var(--card));
            border-radius: var(--radius);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid hsl(var(--border));
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: hsl(var(--card));
            z-index: 10;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: hsl(var(--foreground));
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: hsl(var(--muted-foreground));
            cursor: pointer;
            padding: 4px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: hsl(var(--muted));
            color: #ef4444;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid hsl(var(--border));
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            position: sticky;
            bottom: 0;
            background: hsl(var(--card));
        }

        /* ========== LOADING & EMPTY STATES ========== */
        .loading {
            text-align: center;
            padding: 60px 24px;
            color: hsl(var(--muted-foreground));
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid hsl(var(--border));
            border-top-color: hsl(var(--primary));
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 24px;
            color: hsl(var(--muted-foreground));
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: hsl(var(--foreground));
        }

        .empty-description {
            font-size: 14px;
            max-width: 400px;
            margin: 0 auto;
        }

        /* ========== PAGINATION ========== */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 24px;
            border-top: 1px solid hsl(var(--border));
        }

        .page-btn {
            padding: 8px 16px;
            border: 1px solid hsl(var(--border));
            background: hsl(var(--card));
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            color: hsl(var(--foreground));
        }

        .page-btn:hover:not(.active) {
            background: hsl(var(--muted));
            border-color: hsl(var(--primary));
            color: hsl(var(--primary));
        }

        .page-btn.active {
            background: hsl(var(--primary));
            color: white;
            border-color: hsl(var(--primary));
        }

        /* ========== TOAST NOTIFICATIONS ========== */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }

        .toast {
            background: hsl(var(--card));
            border-left: 4px solid #10b981;
            border-radius: var(--radius);
            padding: 16px 20px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-error { border-left-color: #ef4444; }
        .toast-warning { border-left-color: #f59e0b; }
        .toast-info { border-left-color: #3b82f6; }

        .toast-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            flex: 1;
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            color: hsl(var(--muted-foreground));
            cursor: pointer;
            padding: 0 0 0 16px;
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .toast-close:hover {
            opacity: 1;
            color: hsl(var(--foreground));
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 1200px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                bottom: 0;
                transition: all 0.3s ease;
                z-index: 1000;
            }
            
            .sidebar.show {
                left: 0;
                box-shadow: 0 0 50px rgba(0, 0, 0, 0.3);
            }
            
            .menu-toggle {
                display: block;
            }
            
            .main-content {
                width: 100%;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .search-container {
                width: 200px;
            }
        }

        @media (max-width: 768px) {
            .content-wrapper {
                padding: 20px;
            }
            
            .topbar {
                padding: 0 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .card-header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .card-tools {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-container {
                width: 100%;
            }
            
            .section-header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .section-actions {
                flex-wrap: wrap;
            }
            
            .modal-content {
                margin: 10px;
            }
        }

        /* ========== UTILITY CLASSES ========== */
        .d-none { display: none !important; }
        .d-flex { display: flex; }
        .d-block { display: block; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 12px; }
        .gap-4 { gap: 24px; }
        .mt-3 { margin-top: 24px; }
        .mb-3 { margin-bottom: 24px; }
        .ml-auto { margin-left: auto; }
        .text-center { text-align: center; }
        .text-success { color: #10b981; }
        .text-danger { color: #ef4444; }
        .text-warning { color: #f59e0b; }
        .text-muted { color: hsl(var(--muted-foreground)); }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-header">
                <div class="logo-icon" style="width: 80px; height: 80px; font-size: 32px; margin: 0 auto 20px;">F</div>
                <h1 class="login-title">FOOTMAN Admin</h1>
                <p class="login-subtitle">Business Administration Panel</p>
            </div>
            
            <div class="login-info">
                <i class="fas fa-info-circle"></i>
                <strong>Default Admin Credentials:</strong><br>
                Phone: <code>01700000000</code><br>
                Password: <code>admin123</code>
            </div>
            
            <div class="form-group">
                <label class="form-label">Phone Number</label>
                <input type="tel" id="loginPhone" class="form-control" value="01700000000" placeholder="Enter phone number">
            </div>
            
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="loginPassword" class="form-control" placeholder="Enter password">
            </div>
            
            <div class="login-error" id="loginError"></div>
            
            <button class="btn btn-primary" id="loginBtn" style="width: 100%; padding: 16px; font-size: 16px;">
                <i class="fas fa-lock"></i> Login to Admin Panel
            </button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Main App Container -->
    <div class="app-container d-none" id="appContainer">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">F</div>
                    <div class="logo-text">
                        <h2>FOOTMAN</h2>
                        <span>Business Admin</span>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="nav-menu">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <button class="nav-item active" data-page="dashboard">
                        <i class="fas fa-chart-pie"></i>
                        Dashboard
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">User Management</div>
                    <button class="nav-item" data-page="users">
                        <i class="fas fa-users"></i>
                        All Users
                        <span class="nav-badge" id="usersBadge">0</span>
                    </button>
                    <button class="nav-item" data-page="partners">
                        <i class="fas fa-truck"></i>
                        Delivery Partners
                        <span class="nav-badge" id="partnersBadge">0</span>
                    </button>
                    <button class="nav-item" data-page="customers">
                        <i class="fas fa-user"></i>
                        Customers
                        <span class="nav-badge" id="customersBadge">0</span>
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Business Operations</div>
                    <button class="nav-item" data-page="requests">
                        <i class="fas fa-box"></i>
                        Delivery Requests
                        <span class="nav-badge" id="requestsBadge">0</span>
                    </button>
                    <button class="nav-item" data-page="earnings">
                        <i class="fas fa-dollar-sign"></i>
                        Earnings & Reports
                    </button>
                    <button class="nav-item" data-page="online">
                        <i class="fas fa-map-marker-alt"></i>
                        Online Partners
                        <span class="nav-badge" id="onlineBadge">0</span>
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Verification</div>
                    <button class="nav-item" data-page="pending">
                        <i class="fas fa-clock"></i>
                        Pending Approvals
                        <span class="nav-badge" id="pendingBadge">0</span>
                    </button>
                    <button class="nav-item" data-page="rejected">
                        <i class="fas fa-times-circle"></i>
                        Rejected Partners
                        <span class="nav-badge" id="rejectedBadge">0</span>
                    </button>
                    <button class="nav-item" data-page="documents">
                        <i class="fas fa-file-alt"></i>
                        Document Verification
                    </button>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-menu">
                    <div class="user-avatar" id="adminAvatar">A</div>
                    <div class="user-info">
                        <div class="user-name" id="adminName">Admin User</div>
                        <div class="user-email" id="adminEmail">admin@footman.com</div>
                    </div>
                </div>
                <button class="btn btn-secondary btn-sm" id="logoutBtn" style="width: 100%;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="topbar">
                <div class="topbar-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" id="pageTitle">Dashboard</h1>
                </div>
                <div class="topbar-right">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="globalSearch" placeholder="Search...">
                    </div>
                    <button class="theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="notification-btn" id="notificationBtn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge">0</span>
                    </button>
                    <div class="user-menu">
                        <div class="user-avatar" id="topbarAvatar">A</div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-wrapper" id="contentArea"></div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">User Details</h2>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading user details...</p>
                </div>
            </div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <div class="modal" id="documentsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="documentsTitle">Partner Documents</h2>
                <button class="close-btn" id="closeDocumentsModal">&times;</button>
            </div>
            <div class="modal-body" id="documentsBody">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading documents...</p>
                </div>
            </div>
            <div class="modal-footer" id="documentsFooter"></div>
        </div>
    </div>

    <div class="modal" id="requestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="requestTitle">Request Details</h2>
                <button class="close-btn" id="closeRequestModal">&times;</button>
            </div>
            <div class="modal-body" id="requestBody">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading request details...</p>
                </div>
            </div>
            <div class="modal-footer" id="requestFooter"></div>
        </div>
    </div>

    <div class="modal" id="rejectReasonModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Reject Partner</h2>
                <button class="close-btn" id="closeRejectModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Rejection Reason <span style="color: #ef4444;">*</span></label>
                    <textarea id="rejectReasonInput" class="form-control" rows="4" placeholder="Enter detailed reason why this partner is being rejected..." style="resize: vertical;"></textarea>
                    <small style="color: hsl(var(--muted-foreground)); margin-top: 8px; display: block;">
                        This reason will be sent to the partner via push notification and stored in their record.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="confirmRejectBtn">
                    <i class="fas fa-times"></i> Reject Partner
                </button>
                <button class="btn btn-secondary" id="cancelRejectBtn">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION ==========
        const Config = {
            API_BASE: 'https://footman-backend.onrender.com/api/v1',
            TOKEN_KEY: 'footman_admin_token',
            USER_KEY: 'footman_admin_user',
            REFRESH_INTERVAL: 30000,
            ITEMS_PER_PAGE: 20
        };

        // ========== STATE MANAGEMENT ==========
        const State = {
            token: null,
            currentPage: 'dashboard',
            currentUser: null,
            isLoading: false,
            pendingRejectId: null,
            charts: {},
            filters: {
                users: { page: 1, limit: 20, search: '', user_type: '', status: '' },
                partners: { page: 1, limit: 20, search: '', status: '' },
                customers: { page: 1, limit: 20, search: '', status: '' },
                requests: { page: 1, limit: 20, search: '', status: '' },
                online: { page: 1, limit: 20 },
                pending: { page: 1, limit: 20, search: '' },
                rejected: { page: 1, limit: 20, search: '' },
                documents: { page: 1, limit: 20, search: '', status: '' }
            },
            map: null,
            mapMarkers: []
        };

        // ========== THEME MANAGEMENT ==========
        function initTheme() {
            const savedTheme = localStorage.getItem('footman_theme');
            const themeToggle = document.getElementById('themeToggle');
            const icon = themeToggle.querySelector('i');
            
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            }
            
            themeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                if (document.documentElement.classList.contains('dark')) {
                    localStorage.setItem('footman_theme', 'dark');
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                } else {
                    localStorage.setItem('footman_theme', 'light');
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                }
            });
        }

        // ========== AUTHENTICATION ==========
        function initAuth() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get("token");
            
            if (urlToken) {
                State.token = urlToken;
                localStorage.setItem(Config.TOKEN_KEY, urlToken);
                window.history.replaceState({}, document.title, window.location.pathname);
                showApp();
                return;
            }
            
            State.token = localStorage.getItem(Config.TOKEN_KEY);
            const userStr = localStorage.getItem(Config.USER_KEY);
            
            if (State.token && userStr) {
                try {
                    State.currentUser = JSON.parse(userStr);
                    showApp();
                } catch (e) {
                    logout();
                }
            } else {
                showLogin();
            }
        }
        
        function showLogin() {
            document.getElementById("loginScreen").style.display = "flex";
            document.getElementById("appContainer").classList.add("d-none");
        }
        
        function showApp() {
            document.getElementById("loginScreen").style.display = "none";
            document.getElementById("appContainer").classList.remove("d-none");
            updateAdminInfo();
            initTheme();
            loadPage(State.currentPage);
            startAutoRefresh();
        }

        async function login(phone, password) {
            const loginBtn = document.getElementById("loginBtn");
            const originalText = loginBtn.innerHTML;
            const errorDisplay = document.getElementById("loginError");
            
            try {
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
                loginBtn.disabled = true;
                errorDisplay.style.display = "none";
                
                const response = await fetch(`${Config.API_BASE}/auth/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ phone, password })
                });
                
                const data = await response.json();
                
                if (data.success && data.data.token) {
                    State.token = data.data.token;
                    State.currentUser = data.data.user;
                    
                    localStorage.setItem(Config.TOKEN_KEY, State.token);
                    localStorage.setItem(Config.USER_KEY, JSON.stringify(data.data.user));
                    
                    showToast("Login successful!", "success");
                    showApp();
                    loadDashboard();
                } else {
                    throw new Error(data.message || "Login failed");
                }
            } catch (error) {
                errorDisplay.textContent = error.message;
                errorDisplay.style.display = "block";
                showToast(error.message, "error");
            } finally {
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                State.token = null;
                State.currentUser = null;
                localStorage.removeItem(Config.TOKEN_KEY);
                localStorage.removeItem(Config.USER_KEY);
                showLogin();
            }
        }

        // ========== API SERVICE ==========
        async function apiRequest(endpoint, options = {}) {
            if (!State.token) {
                showLogin();
                throw new Error('Not authenticated');
            }
            
            const url = `${Config.API_BASE}${endpoint}`;
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${State.token}`,
                ...options.headers
            };
            
            try {
                const response = await fetch(url, { ...options, headers });
                
                if (response.status === 401) {
                    showToast('Session expired. Please login again.', 'error');
                    logout();
                    return null;
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }
                
                return data;
            } catch (error) {
                console.error('API Error:', error);
                showToast(error.message, 'error');
                throw error;
            }
        }

        // ========== UI UTILITIES ==========
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: '<i class="fas fa-check-circle"></i>',
                error: '<i class="fas fa-exclamation-circle"></i>',
                warning: '<i class="fas fa-exclamation-triangle"></i>',
                info: '<i class="fas fa-info-circle"></i>'
            };
            
            toast.innerHTML = `
                <div class="toast-content">
                    <span class="toast-icon">${icons[type] || icons.info}</span>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        function formatCurrency(amount) {
            return ` ${parseFloat(amount || 0).toFixed(2)}`;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatTimeAgo(dateString) {
            if (!dateString) return 'Never';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${Math.floor(diffHours / 24)}d ago`;
        }

        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }

        function setLoading(loading) {
            State.isLoading = loading;
            document.body.style.cursor = loading ? 'wait' : 'default';
        }

        // ========== PAGE LOADING ==========
        function loadPage(page) {
            State.currentPage = page;
            document.getElementById('pageTitle').textContent = getPageTitle(page);
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === page);
            });
            
            switch(page) {
                case 'dashboard': loadDashboard(); break;
                case 'users': loadUsers(); break;
                case 'partners': loadPartners(); break;
                case 'customers': loadCustomers(); break;
                case 'requests': loadRequests(); break;
                case 'earnings': loadEarnings(); break;
                case 'online': loadOnlinePartners(); break;
                case 'pending': loadPendingApprovals(); break;
                case 'rejected': loadRejectedPartners(); break;
                case 'documents': loadDocumentVerification(); break;
                default: loadDashboard();
            }
        }

        function getPageTitle(page) {
            const titles = {
                dashboard: 'Dashboard',
                users: 'User Management',
                partners: 'Delivery Partners',
                customers: 'Customers',
                requests: 'Delivery Requests',
                earnings: 'Earnings & Reports',
                online: 'Online Partners',
                pending: 'Pending Approvals',
                rejected: 'Rejected Partners',
                documents: 'Document Verification'
            };
            return titles[page] || 'Dashboard';
        }

        // ========== DASHBOARD ==========
        async function loadDashboard() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading dashboard...</p>
                </div>
            `;
            
            try {
                const dashboardData = await apiRequest('/admin/dashboard');
                
                if (dashboardData?.success) {
                    renderDashboard(dashboardData.data);
                } else {
                    throw new Error('Failed to load dashboard data');
                }
            } catch (error) {
                contentArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="empty-title">Failed to load dashboard</div>
                        <div class="empty-description">${error.message}</div>
                        <button class="btn btn-primary mt-3" onclick="loadDashboard()">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                `;
            }
        }

        function renderDashboard(data) {
            const stats = data.stats;
            
            document.getElementById('usersBadge').textContent = (stats.total_customers || 0) + (stats.total_delivery_boys || 0);
            document.getElementById('partnersBadge').textContent = stats.total_delivery_boys || 0;
            document.getElementById('customersBadge').textContent = stats.total_customers || 0;
            document.getElementById('requestsBadge').textContent = stats.total_requests || 0;
            document.getElementById('onlineBadge').textContent = stats.online_partners || 0;
            document.getElementById('pendingBadge').textContent = stats.pending_approvals || 0;
            document.getElementById('rejectedBadge').textContent = stats.rejected_partners || 0;
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Business Dashboard</h1>
                    <p class="page-subtitle">Real-time overview of your delivery business</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
                        <div class="stat-content">
                            <h3>Total Revenue</h3>
                            <div class="stat-value">${formatCurrency(stats.total_revenue || 0)}</div>
                            <div class="stat-change">
                                <i class="fas fa-arrow-up"></i> ${stats.total_requests || 0} requests
                            </div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-wallet"></i></div>
                        <div class="stat-content">
                            <h3>Your Commission</h3>
                            <div class="stat-value">${formatCurrency(stats.total_commission || 0)}</div>
                            <div class="stat-change">
                                <i class="fas fa-percentage"></i> 10% of revenue
                            </div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-content">
                            <h3>Total Users</h3>
                            <div class="stat-value">${(stats.total_customers || 0) + (stats.total_delivery_boys || 0)}</div>
                            <div class="stat-change">
                                <i class="fas fa-circle" style="color: #10b981; font-size: 8px;"></i> ${stats.online_partners || 0} partners online
                            </div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-box"></i></div>
                        <div class="stat-content">
                            <h3>Total Requests</h3>
                            <div class="stat-value">${stats.total_requests || 0}</div>
                            <div class="stat-change">
                                <i class="fas fa-calendar"></i> ${stats.today_requests || 0} today
                            </div>
                        </div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Revenue Overview</h3>
                            <select class="filter-select" id="revenuePeriod" onchange="loadRevenueTimeSeries(this.value)">
                                <option value="7days">Last 7 Days</option>
                                <option value="30days">Last 30 Days</option>
                                <option value="90days">Last 90 Days</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Request Status Distribution</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="requestsChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="data-section">
                    <div class="section-header">
                        <h3 class="section-title">Recent Activity</h3>
                        <div class="section-actions">
                            <button class="btn btn-outline btn-sm" onclick="loadDashboard()">
                                <i class="fas fa-redo"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="data-card">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Customer</th>
                                        <th>Partner</th>
                                        <th>Status</th>
                                        <th>Amount</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="activityTable">
                                    <tr>
                                        <td colspan="5" class="loading">
                                            <div class="loading-spinner"></div>
                                            <p>Loading activity...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            initRevenueChart();
            initRequestsChart();
            loadRevenueTimeSeries('7days');
            
            if (stats.status_breakdown) {
                updateRequestsChart(stats.status_breakdown);
            }
            
            loadRecentActivity();
        }

        function initRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (State.charts.revenue) {
                State.charts.revenue.destroy();
            }
            
            State.charts.revenue = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{
                    label: 'Revenue',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]},
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: (context) => `Revenue: ${formatCurrency(context.raw)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: (value) => formatCurrency(value) }
                        }
                    }
                }
            });
        }

        function initRequestsChart() {
            const ctx = document.getElementById('requestsChart').getContext('2d');
            
            if (State.charts.requests) {
                State.charts.requests.destroy();
            }
            
            State.charts.requests = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#3b82f6'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { display: true, position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        async function loadRevenueTimeSeries(period) {
            try {
                const revenueData = await apiRequest(`/admin/revenue-timeseries?period=${period}`);
                if (revenueData?.success && revenueData.data.revenue_data) {
                    updateRevenueChart(revenueData.data.revenue_data);
                }
            } catch (error) {
                console.error('Revenue time series error:', error);
            }
        }

        function updateRevenueChart(revenueData) {
            if (!State.charts.revenue) return;
            
            State.charts.revenue.data.labels = revenueData.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            State.charts.revenue.data.datasets[0].data = revenueData.map(item => item.revenue);
            State.charts.revenue.update();
        }

        function updateRequestsChart(statusBreakdown) {
            if (!State.charts.requests) return;
            
            State.charts.requests.data.labels = Object.keys(statusBreakdown).map(key => 
                key.charAt(0).toUpperCase() + key.slice(1)
            );
            State.charts.requests.data.datasets[0].data = Object.values(statusBreakdown);
            State.charts.requests.update();
        }

        async function loadRecentActivity() {
            try {
                const requests = await apiRequest('/admin/requests?limit=10&page=1');
                
                if (!requests?.success) {
                    throw new Error('Failed to load activity');
                }
                
                const activityTable = document.getElementById('activityTable');
                const recentRequests = requests.data.requests.slice(0, 10);
                
                if (recentRequests.length === 0) {
                    activityTable.innerHTML = `
                        <tr>
                            <td colspan="5" class="empty-state">
                                <div class="empty-icon"><i class="fas fa-inbox"></i></div>
                                <div class="empty-title">No recent activity</div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                activityTable.innerHTML = recentRequests.map(req => {
                    const statusIcons = {
                        completed: '<i class="fas fa-check-circle" style="color: #10b981;"></i>',
                        cancelled: '<i class="fas fa-times-circle" style="color: #ef4444;"></i>',
                        searching: '<i class="fas fa-search" style="color: #f59e0b;"></i>',
                        accepted: '<i class="fas fa-check" style="color: #10b981;"></i>',
                        ongoing: '<i class="fas fa-truck" style="color: #3b82f6;"></i>'
                    };
                    
                    return `
                        <tr>
                            <td>
                                <div class="user-cell">
                                    <div class="avatar">
                                        ${req.customer?.profile_image_url ? 
                                            `<img src="${req.customer.profile_image_url}" alt="${req.customer.full_name}">` : 
                                            getInitials(req.customer?.full_name)}
                                    </div>
                                    <div class="user-info">
                                        <div class="user-name">${req.customer?.full_name || 'Customer'}</div>
                                        <div class="user-email">${req.customer?.phone || ''}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                ${req.footman ? `
                                    <div class="user-cell">
                                        <div class="avatar">
                                            ${req.footman.profile_image_url ? 
                                                `<img src="${req.footman.profile_image_url}" alt="${req.footman.full_name}">` : 
                                                getInitials(req.footman.full_name)}
                                        </div>
                                        <div class="user-info">
                                            <div class="user-name">${req.footman.full_name}</div>
                                            <div class="user-email">${req.footman.phone}</div>
                                        </div>
                                    </div>
                                ` : '-'}
                            </td>
                            <td>
                                <span class="status-badge status-${req.request_status}">
                                    ${statusIcons[req.request_status] || ''} 
                                    ${req.request_status?.replace(/_/g, ' ') || 'Unknown'}
                                </span>
                            </td>
                            <td><strong>${formatCurrency(req.base_price)}</strong></td>
                            <td>${formatTimeAgo(req.created_at)}</td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Recent activity error:', error);
            }
        }

        // ========== USERS PAGE ==========
        async function loadUsers() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">User Management</h1>
                    <p class="page-subtitle">Manage all user accounts in the system</p>
                </div>
                
                <div class="data-card">
                    <div class="card-header">
                        <h3 class="card-title">All Users</h3>
                        <div class="card-tools">
                            <div class="search-container" style="width: 250px;">
                                <i class="fas fa-search"></i>
                                <input type="text" id="userSearch" placeholder="Search users..." onkeyup="debounceSearchUsers()">
                            </div>
                            <select class="filter-select" id="userTypeFilter" onchange="filterUsers()">
                                <option value="">All Types</option>
                                <option value="admin">Admin</option>
                                <option value="delivery">Delivery Partner</option>
                                <option value="customer">Customer</option>
                            </select>
                            <select class="filter-select" id="userStatusFilter" onchange="filterUsers()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Contact</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <tr>
                                    <td colspan="6" class="loading">
                                        <div class="loading-spinner"></div>
                                        <p>Loading users...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="usersPagination"></div>
                </div>
            `;
            
            await fetchUsers();
        }

        let searchTimeout;
        function debounceSearchUsers() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                State.filters.users.search = document.getElementById('userSearch').value;
                State.filters.users.page = 1;
                fetchUsers();
            }, 500);
        }

        function filterUsers() {
            State.filters.users.user_type = document.getElementById('userTypeFilter').value;
            State.filters.users.status = document.getElementById('userStatusFilter').value;
            State.filters.users.page = 1;
            fetchUsers();
        }

        async function fetchUsers() {
            try {
                const params = new URLSearchParams(State.filters.users);
                const result = await apiRequest(`/admin/users?${params}`);
                
                if (result?.success) {
                    renderUsersTable(result.data.users);
                    renderPagination('usersPagination', result.data.pagination.pages, State.filters.users.page, (page) => {
                        State.filters.users.page = page;
                        fetchUsers();
                    });
                }
            } catch (error) {
                console.error('Users load error:', error);
            }
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTable');
            
            if (!users || users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-icon"><i class="fas fa-users"></i></div>
                            <div class="empty-title">No users found</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = users.map(user => {
                const userType = user.user_type || 'customer';
                const isActive = user.is_active !== false;
                
                let statusClass = isActive ? 'status-active' : 'status-inactive';
                let statusText = isActive ? 'Active' : 'Inactive';
                
                if (userType === 'delivery' && !isActive && user.rejection_reason) {
                    statusClass = 'status-rejected';
                    statusText = 'Rejected';
                } else if (userType === 'delivery' && !isActive && !user.rejection_reason) {
                    statusClass = 'status-pending';
                    statusText = 'Pending';
                }
                
                return `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="avatar">
                                    ${user.profile_image_url ? 
                                        `<img src="${user.profile_image_url}" alt="${user.full_name}">` : 
                                        getInitials(user.full_name)}
                                </div>
                                <div class="user-info">
                                    <div class="user-name">${user.full_name || 'N/A'}</div>
                                    <div class="user-email">${user.email || 'No email'}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>${user.phone || 'N/A'}</div>
                            ${user.emergency_contact_phone ? `<small class="text-muted">Emergency: ${user.emergency_contact_phone}</small>` : ''}
                        </td>
                        <td>
                            <span class="status-badge ${userType === 'admin' ? 'status-active' : userType === 'delivery' ? 'status-online' : 'status-info'}">
                                ${userType === 'admin' ? '<i class="fas fa-crown"></i> Admin' : 
                                  userType === 'delivery' ? '<i class="fas fa-truck"></i> Partner' : 
                                  '<i class="fas fa-user"></i> Customer'}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                ${statusClass === 'status-active' ? '<i class="fas fa-check-circle"></i>' : 
                                  statusClass === 'status-pending' ? '<i class="fas fa-clock"></i>' : 
                                  statusClass === 'status-rejected' ? '<i class="fas fa-times-circle"></i>' : 
                                  '<i class="fas fa-circle"></i>'} ${statusText}
                            </span>
                        </td>
                        <td>${formatDate(user.created_at)}</td>
                        <td>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-primary" onclick="viewUserDetails(${user.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${userType === 'delivery' && !isActive && !user.rejection_reason ? 
                                    `<button class="btn btn-sm btn-success" onclick="approvePartner(${user.id})">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="openRejectModal(${user.id})">
                                        <i class="fas fa-times"></i>
                                    </button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== PARTNERS PAGE ==========
        async function loadPartners() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Delivery Partners</h1>
                    <p class="page-subtitle">Manage and monitor delivery partners</p>
                </div>
                
                <div class="data-card">
                    <div class="card-header">
                        <h3 class="card-title">Delivery Partners</h3>
                        <div class="card-tools">
                            <div class="search-container" style="width: 250px;">
                                <i class="fas fa-search"></i>
                                <input type="text" id="partnerSearch" placeholder="Search partners..." onkeyup="debounceSearchPartners()">
                            </div>
                            <select class="filter-select" id="partnerStatusFilter" onchange="filterPartners()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="pending">Pending</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Partner</th>
                                    <th>Contact</th>
                                    <th>Status</th>
                                    <th>Rating</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="partnersTable">
                                <tr>
                                    <td colspan="5" class="loading">
                                        <div class="loading-spinner"></div>
                                        <p>Loading partners...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="partnersPagination"></div>
                </div>
            `;
            
            await fetchPartners();
        }

        function debounceSearchPartners() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                State.filters.partners.search = document.getElementById('partnerSearch').value;
                State.filters.partners.page = 1;
                fetchPartners();
            }, 500);
        }

        function filterPartners() {
            State.filters.partners.status = document.getElementById('partnerStatusFilter').value;
            State.filters.partners.page = 1;
            fetchPartners();
        }

        async function fetchPartners() {
            try {
                const params = new URLSearchParams({ ...State.filters.partners, user_type: 'delivery' });
                const result = await apiRequest(`/admin/users?${params}`);
                
                if (result?.success) {
                    renderPartnersTable(result.data.users);
                    renderPagination('partnersPagination', result.data.pagination.pages, State.filters.partners.page, (page) => {
                        State.filters.partners.page = page;
                        fetchPartners();
                    });
                }
            } catch (error) {
                console.error('Partners load error:', error);
            }
        }

        function renderPartnersTable(partners) {
            const tbody = document.getElementById('partnersTable');
            
            if (!partners || partners.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div class="empty-icon"><i class="fas fa-truck"></i></div>
                            <div class="empty-title">No partners found</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = partners.map(partner => {
                const isActive = partner.is_active !== false;
                const isRejected = partner.rejection_reason !== null;
                
                let statusClass = 'status-pending';
                let statusText = 'Pending';
                
                if (isActive) {
                    statusClass = 'status-active';
                    statusText = 'Active';
                } else if (isRejected) {
                    statusClass = 'status-rejected';
                    statusText = 'Rejected';
                }
                
                return `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="avatar">
                                    ${partner.profile_image_url ? 
                                        `<img src="${partner.profile_image_url}" alt="${partner.full_name}">` : 
                                        getInitials(partner.full_name)}
                                </div>
                                <div class="user-info">
                                    <div class="user-name">${partner.full_name || 'N/A'}</div>
                                    <div class="user-email">${partner.email || 'No email'}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>${partner.phone || 'N/A'}</div>
                            ${partner.emergency_contact_phone ? `<small class="text-muted">Emergency: ${partner.emergency_contact_phone}</small>` : ''}
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                ${statusClass === 'status-active' ? '<i class="fas fa-check-circle"></i>' : 
                                  statusClass === 'status-pending' ? '<i class="fas fa-clock"></i>' : 
                                  '<i class="fas fa-times-circle"></i>'} ${statusText}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex align-center gap-1">
                                <i class="fas fa-star" style="color: #f59e0b;"></i>
                                <span>${partner.rating || 'N/A'}</span>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-primary" onclick="viewUserDetails(${partner.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${!isActive && !isRejected ? 
                                    `<button class="btn btn-sm btn-success" onclick="approvePartner(${partner.id})">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="openRejectModal(${partner.id})">
                                        <i class="fas fa-times"></i>
                                    </button>` : ''}
                                <button class="btn btn-sm btn-info" onclick="viewPartnerDocuments(${partner.id})">
                                    <i class="fas fa-file-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== CUSTOMERS PAGE ==========
        async function loadCustomers() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Customers</h1>
                    <p class="page-subtitle">Manage customer accounts</p>
                </div>
                
                <div class="data-card">
                    <div class="card-header">
                        <h3 class="card-title">All Customers</h3>
                        <div class="card-tools">
                            <div class="search-container" style="width: 250px;">
                                <i class="fas fa-search"></i>
                                <input type="text" id="customerSearch" placeholder="Search customers..." onkeyup="debounceSearchCustomers()">
                            </div>
                            <select class="filter-select" id="customerStatusFilter" onchange="filterCustomers()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Contact</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customersTable">
                                <tr>
                                    <td colspan="4" class="loading">
                                        <div class="loading-spinner"></div>
                                        <p>Loading customers...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="customersPagination"></div>
                </div>
            `;
            
            await fetchCustomers();
        }

        function debounceSearchCustomers() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                State.filters.customers.search = document.getElementById('customerSearch').value;
                State.filters.customers.page = 1;
                fetchCustomers();
            }, 500);
        }

        function filterCustomers() {
            State.filters.customers.status = document.getElementById('customerStatusFilter').value;
            State.filters.customers.page = 1;
            fetchCustomers();
        }

        async function fetchCustomers() {
            try {
                const params = new URLSearchParams({ ...State.filters.customers, user_type: 'customer' });
                const result = await apiRequest(`/admin/users?${params}`);
                
                if (result?.success) {
                    renderCustomersTable(result.data.users);
                    renderPagination('customersPagination', result.data.pagination.pages, State.filters.customers.page, (page) => {
                        State.filters.customers.page = page;
                        fetchCustomers();
                    });
                }
            } catch (error) {
                console.error('Customers load error:', error);
            }
        }

        function renderCustomersTable(customers) {
            const tbody = document.getElementById('customersTable');
            
            if (!customers || customers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <div class="empty-icon"><i class="fas fa-user"></i></div>
                            <div class="empty-title">No customers found</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = customers.map(customer => {
                const isActive = customer.is_active !== false;
                
                return `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="avatar">
                                    ${customer.profile_image_url ? 
                                        `<img src="${customer.profile_image_url}" alt="${customer.full_name}">` : 
                                        getInitials(customer.full_name)}
                                </div>
                                <div class="user-info">
                                    <div class="user-name">${customer.full_name || 'N/A'}</div>
                                    <div class="user-email">${customer.email || 'No email'}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>${customer.phone || 'N/A'}</div>
                        </td>
                        <td>
                            <span class="status-badge ${isActive ? 'status-active' : 'status-inactive'}">
                                <i class="fas ${isActive ? 'fa-check-circle' : 'fa-circle'}"></i>
                                ${isActive ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewUserDetails(${customer.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== REQUESTS PAGE ==========
        async function loadRequests() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Delivery Requests</h1>
                    <p class="page-subtitle">Monitor and manage all delivery requests</p>
                </div>
                
                <div class="data-card">
                    <div class="card-header">
                        <h3 class="card-title">All Requests</h3>
                        <div class="card-tools">
                            <div class="search-container" style="width: 250px;">
                                <i class="fas fa-search"></i>
                                <input type="text" id="requestSearch" placeholder="Search requests..." onkeyup="debounceSearchRequests()">
                            </div>
                            <select class="filter-select" id="requestStatusFilter" onchange="filterRequests()">
                                <option value="">All Status</option>
                                <option value="completed">Completed</option>
                                <option value="ongoing">Ongoing</option>
                                <option value="searching">Searching</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Request #</th>
                                    <th>Customer</th>
                                    <th>Partner</th>
                                    <th>Status</th>
                                    <th>Amount</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="requestsTable">
                                <tr>
                                    <td colspan="7" class="loading">
                                        <div class="loading-spinner"></div>
                                        <p>Loading requests...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="requestsPagination"></div>
                </div>
            `;
            
            await fetchRequests();
        }

        function debounceSearchRequests() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                State.filters.requests.search = document.getElementById('requestSearch').value;
                State.filters.requests.page = 1;
                fetchRequests();
            }, 500);
        }

        function filterRequests() {
            State.filters.requests.status = document.getElementById('requestStatusFilter').value;
            State.filters.requests.page = 1;
            fetchRequests();
        }

        async function fetchRequests() {
            try {
                const params = new URLSearchParams(State.filters.requests);
                const result = await apiRequest(`/admin/requests?${params}`);
                
                if (result?.success) {
                    renderRequestsTable(result.data.requests);
                    renderPagination('requestsPagination', result.data.pagination.pages, State.filters.requests.page, (page) => {
                        State.filters.requests.page = page;
                        fetchRequests();
                    });
                }
            } catch (error) {
                console.error('Requests load error:', error);
            }
        }

        function renderRequestsTable(requests) {
            const tbody = document.getElementById('requestsTable');
            
            if (!requests || requests.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-icon"><i class="fas fa-box"></i></div>
                            <div class="empty-title">No requests found</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = requests.map(req => {
                const statusIcons = {
                    completed: '<i class="fas fa-check-circle" style="color: #10b981;"></i>',
                    cancelled: '<i class="fas fa-times-circle" style="color: #ef4444;"></i>',
                    searching: '<i class="fas fa-search" style="color: #f59e0b;"></i>',
                    accepted: '<i class="fas fa-check" style="color: #10b981;"></i>',
                    ongoing: '<i class="fas fa-truck" style="color: #3b82f6;"></i>'
                };
                
                return `
                    <tr>
                        <td>${req.request_number}</td>
                        <td>
                            <div class="user-cell">
                                <div class="avatar">
                                    ${req.customer?.profile_image_url ? 
                                        `<img src="${req.customer.profile_image_url}" alt="${req.customer.full_name}">` : 
                                        getInitials(req.customer?.full_name)}
                                </div>
                                <div class="user-info">
                                    <div class="user-name">${req.customer?.full_name || 'Customer'}</div>
                                    <div class="user-email">${req.customer?.phone || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            ${req.footman ? `
                                <div class="user-cell">
                                    <div class="avatar">
                                        ${req.footman.profile_image_url ? 
                                            `<img src="${req.footman.profile_image_url}" alt="${req.footman.full_name}">` : 
                                            getInitials(req.footman.full_name)}
                                    </div>
                                    <div class="user-info">
                                        <div class="user-name">${req.footman.full_name}</div>
                                        <div class="user-email">${req.footman.phone}</div>
                                    </div>
                                </div>
                            ` : '-'}
                        </td>
                        <td>
                            <span class="status-badge status-${req.request_status}">
                                ${statusIcons[req.request_status] || ''} 
                                ${req.request_status?.replace(/_/g, ' ') || 'Unknown'}
                            </span>
                        </td>
                        <td><strong>${formatCurrency(req.base_price)}</strong></td>
                        <td>${formatDateTime(req.created_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewRequestDetails(${req.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== EARNINGS PAGE ==========
        async function loadEarnings() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Earnings & Reports</h1>
                    <p class="page-subtitle">Financial overview and business reports</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
                        <div class="stat-content">
                            <h3>Total Revenue</h3>
                            <div class="stat-value" id="earningsRevenue">Loading...</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-wallet"></i></div>
                        <div class="stat-content">
                            <h3>Your Commission</h3>
                            <div class="stat-value" id="earningsCommission">Loading...</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-truck"></i></div>
                        <div class="stat-content">
                            <h3>Partner Earnings</h3>
                            <div class="stat-value" id="earningsPartner">Loading...</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-percentage"></i></div>
                        <div class="stat-content">
                            <h3>Success Rate</h3>
                            <div class="stat-value" id="successRate">Loading...</div>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                const requests = await apiRequest('/admin/requests?limit=1000');
                
                if (requests?.success) {
                    const allRequests = requests.data.requests;
                    const totals = requests.data.totals;
                    
                    document.getElementById('earningsRevenue').textContent = formatCurrency(totals.total_revenue || 0);
                    document.getElementById('earningsCommission').textContent = formatCurrency(totals.total_commission || 0);
                    document.getElementById('earningsPartner').textContent = formatCurrency(totals.partner_earnings || 0);
                    
                    const totalRequests = totals.total_requests || 0;
                    const completedRequests = allRequests.filter(req => req.request_status === 'completed').length;
                    const successRate = totalRequests > 0 ? Math.round((completedRequests / totalRequests) * 100) : 0;
                    document.getElementById('successRate').textContent = `${successRate}%`;
                }
            } catch (error) {
                console.error('Earnings load error:', error);
            }
        }

        // ========== ONLINE PARTNERS PAGE ==========
        async function loadOnlinePartners() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Online Partners</h1>
                    <p class="page-subtitle">Partners currently available for deliveries</p>
                </div>
                
                <div class="data-card">
                    <div class="card-header">
                        <h3 class="card-title">Currently Online</h3>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Partner</th>
                                    <th>Status</th>
                                    <th>Location</th>
                                    <th>Last Update</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="onlineTable">
                                <tr>
                                    <td colspan="5" class="loading">
                                        <div class="loading-spinner"></div>
                                        <p>Loading online partners...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            try {
                const result = await apiRequest('/admin/online-partners');
                
                if (result?.success) {
                    renderOnlineTable(result.data.partners);
                }
            } catch (error) {
                console.error('Online partners error:', error);
            }
        }

        function renderOnlineTable(partners) {
            const tbody = document.getElementById('onlineTable');
            
            if (!partners || partners.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div class="empty-icon"><i class="fas fa-map-marker-alt"></i></div>
                            <div class="empty-title">No partners online</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = partners.map(partner => `
                <tr>
                    <td>
                        <div class="user-cell">
                            <div class="avatar">
                                ${partner.profile_image_url ? 
                                    `<img src="${partner.profile_image_url}" alt="${partner.full_name}">` : 
                                    getInitials(partner.full_name)}
                            </div>
                            <div class="user-info">
                                <div class="user-name">${partner.full_name || 'N/A'}</div>
                                <div class="user-email">${partner.phone || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge status-online">
                            <i class="fas fa-circle"></i> Online
                        </span>
                    </td>
                    <td>
                        ${partner.latitude && partner.longitude ? 
                            `<small>${partner.latitude.toFixed(4)}, ${partner.longitude.toFixed(4)}</small>` : 
                            '<small class="text-muted">No GPS</small>'}
                    </td>
                    <td>${formatTimeAgo(partner.last_location_update)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewUserDetails(${partner.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // ========== PENDING APPROVALS PAGE ==========
        async function loadPendingApprovals() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Pending Approvals</h1>
                    <p class="page-subtitle">Approve or reject new delivery partners</p>
                </div>
                
                <div class="data-card">
                    <div class="card-header">
                        <h3 class="card-title">Partners Awaiting Approval</h3>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Partner</th>
                                    <th>Applied</th>
                                    <th>Documents</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pendingTable">
                                <tr>
                                    <td colspan="4" class="loading">
                                        <div class="loading-spinner"></div>
                                        <p>Loading pending approvals...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            try {
                const result = await apiRequest('/admin/partners/pending');
                
                if (result?.success) {
                    renderPendingTable(result.data.partners);
                }
            } catch (error) {
                console.error('Pending approvals error:', error);
            }
        }

        function renderPendingTable(partners) {
            const tbody = document.getElementById('pendingTable');
            
            if (!partners || partners.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <div class="empty-icon"><i class="fas fa-clock"></i></div>
                            <div class="empty-title">No pending approvals</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = partners.map(partner => `
                <tr>
                    <td>
                        <div class="user-cell">
                            <div class="avatar">
                                ${partner.profile_image_url ? 
                                    `<img src="${partner.profile_image_url}" alt="${partner.full_name}">` : 
                                    getInitials(partner.full_name)}
                            </div>
                            <div class="user-info">
                                <div class="user-name">${partner.full_name || 'N/A'}</div>
                                <div class="user-email">${partner.phone || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td>${formatDate(partner.created_at)}</td>
                    <td>
                        <div class="d-flex gap-1">
                            ${partner.profile_image_url ? '<span class="status-badge status-active" title="Profile Photo"><i class="fas fa-image"></i></span>' : ''}
                            ${partner.nid_front_image_url ? '<span class="status-badge status-active" title="NID Front"><i class="fas fa-id-card"></i></span>' : ''}
                            ${partner.nid_back_image_url ? '<span class="status-badge status-active" title="NID Back"><i class="fas fa-id-card"></i></span>' : ''}
                        </div>
                    </td>
                    <td>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-success" onclick="approvePartner(${partner.id})">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="openRejectModal(${partner.id})">
                                <i class="fas fa-times"></i> Reject
                            </button>
                            <button class="btn btn-sm btn-info" onclick="viewPartnerDocuments(${partner.id})">
                                <i class="fas fa-file-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // ========== REJECTED PARTNERS PAGE ==========
        async function loadRejectedPartners() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Rejected Partners</h1>
                    <p class="page-subtitle">Partners who were rejected with reasons</p>
                </div>
                
                <div class="data-card">
                    <div class="card-header">
                        <h3 class="card-title">Rejected Partners</h3>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Partner</th>
                                    <th>Rejection Reason</th>
                                    <th>Rejected On</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="rejectedTable">
                                <tr>
                                    <td colspan="4" class="loading">
                                        <div class="loading-spinner"></div>
                                        <p>Loading rejected partners...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            try {
                const result = await apiRequest('/admin/partners/rejected');
                
                if (result?.success) {
                    renderRejectedTable(result.data.partners);
                }
            } catch (error) {
                console.error('Rejected partners error:', error);
            }
        }

        function renderRejectedTable(partners) {
            const tbody = document.getElementById('rejectedTable');
            
            if (!partners || partners.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <div class="empty-icon"><i class="fas fa-times-circle"></i></div>
                            <div class="empty-title">No rejected partners</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = partners.map(partner => `
                <tr>
                    <td>
                        <div class="user-cell">
                            <div class="avatar">
                                ${partner.profile_image_url ? 
                                    `<img src="${partner.profile_image_url}" alt="${partner.full_name}">` : 
                                    getInitials(partner.full_name)}
                            </div>
                            <div class="user-info">
                                <div class="user-name">${partner.full_name || 'N/A'}</div>
                                <div class="user-email">${partner.email || 'No email'}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge status-rejected">
                            <i class="fas fa-exclamation-triangle"></i> ${partner.rejection_reason || 'No reason provided'}
                        </span>
                    </td>
                    <td>${formatDateTime(partner.rejected_at)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewUserDetails(${partner.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // ========== DOCUMENT VERIFICATION PAGE ==========
        async function loadDocumentVerification() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">Document Verification</h1>
                    <p class="page-subtitle">Verify partner documents and identity</p>
                </div>
                
                <div class="data-card">
                    <div class="card-header">
                        <h3 class="card-title">Partner Documents</h3>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Partner</th>
                                    <th>NID Number</th>
                                    <th>Documents</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="documentsTable">
                                <tr>
                                    <td colspan="4" class="loading">
                                        <div class="loading-spinner"></div>
                                        <p>Loading documents...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            try {
                const result = await apiRequest('/admin/documents');
                
                if (result?.success) {
                    renderDocumentsTable(result.data.documents);
                }
            } catch (error) {
                console.error('Documents error:', error);
            }
        }

        function renderDocumentsTable(documents) {
            const tbody = document.getElementById('documentsTable');
            
            if (!documents || documents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <div class="empty-icon"><i class="fas fa-file-alt"></i></div>
                            <div class="empty-title">No documents to verify</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = documents.map(doc => {
                const partner = doc.partner;
                
                return `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="avatar">
                                    ${partner.profile_image_url ? 
                                        `<img src="${partner.profile_image_url}" alt="${partner.name}">` : 
                                        getInitials(partner.name)}
                                </div>
                                <div class="user-info">
                                    <div class="user-name">${partner.name}</div>
                                    <div class="user-email">${partner.phone}</div>
                                </div>
                            </div>
                        </td>
                        <td>${partner.nid || 'Not provided'}</td>
                        <td>
                            <div class="d-flex gap-1">
                                ${partner.profile_image_url ? '<span class="status-badge status-active" title="Profile Photo"><i class="fas fa-image"></i> Photo</span>' : ''}
                                ${partner.nid_front_image_url ? '<span class="status-badge status-active" title="NID Front"><i class="fas fa-id-card"></i> NID F</span>' : ''}
                                ${partner.nid_back_image_url ? '<span class="status-badge status-active" title="NID Back"><i class="fas fa-id-card"></i> NID B</span>' : ''}
                            </div>
                        </td>
                        <td>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-primary" onclick="viewPartnerDocuments(${partner.id})">
                                    <i class="fas fa-file-alt"></i> Review
                                </button>
                                ${partner.status === 'pending' ? 
                                    `<button class="btn btn-sm btn-success" onclick="approvePartner(${partner.id})">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="openRejectModal(${partner.id})">
                                        <i class="fas fa-times"></i> Reject
                                    </button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== PAGINATION ==========
        function renderPagination(containerId, totalPages, currentPage, onPageChange) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            if (currentPage > 1) {
                html += `<button class="page-btn" onclick="(${onPageChange})(${currentPage - 1})"> Prev</button>`;
            }
            
            if (startPage > 1) {
                html += `<button class="page-btn" onclick="(${onPageChange})(1)">1</button>`;
                if (startPage > 2) html += `<span class="text-muted">...</span>`;
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="(${onPageChange})(${i})">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) html += `<span class="text-muted">...</span>`;
                html += `<button class="page-btn" onclick="(${onPageChange})(${totalPages})">${totalPages}</button>`;
            }
            
            if (currentPage < totalPages) {
                html += `<button class="page-btn" onclick="(${onPageChange})(${currentPage + 1})">Next </button>`;
            }
            
            container.innerHTML = html;
        }

        // ========== NAVIGATION & EVENT HANDLERS ==========
        function setupNavigation() {
            document.getElementById('menuToggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('show');
            });
            
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    const page = btn.dataset.page;
                    loadPage(page);
                    if (window.innerWidth <= 1200) {
                        document.getElementById('sidebar').classList.remove('show');
                    }
                });
            });
            
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            document.getElementById('loginBtn').addEventListener('click', () => {
                const phone = document.getElementById('loginPhone').value;
                const password = document.getElementById('loginPassword').value;
                if (!phone || !password) {
                    document.getElementById('loginError').textContent = 'Please enter phone and password';
                    document.getElementById('loginError').style.display = 'block';
                    return;
                }
                login(phone, password);
            });
            
            document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('loginBtn').click();
                }
            });
            
            document.getElementById('globalSearch').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    const query = e.target.value.trim();
                    if (query) {
                        showToast('Search feature coming soon', 'info');
                    }
                }
            });
            
            document.getElementById('closeModal').addEventListener('click', () => {
                document.getElementById('userModal').classList.remove('show');
            });
            
            document.getElementById('closeDocumentsModal').addEventListener('click', () => {
                document.getElementById('documentsModal').classList.remove('show');
            });
            
            document.getElementById('closeRequestModal').addEventListener('click', () => {
                document.getElementById('requestModal').classList.remove('show');
            });
            
            document.getElementById('closeRejectModal').addEventListener('click', () => {
                document.getElementById('rejectReasonModal').classList.remove('show');
            });
            
            document.getElementById('cancelRejectBtn').addEventListener('click', () => {
                document.getElementById('rejectReasonModal').classList.remove('show');
            });
            
            document.getElementById('confirmRejectBtn').addEventListener('click', async () => {
                const reason = document.getElementById('rejectReasonInput').value.trim();
                if (!reason) {
                    showToast('Please enter rejection reason', 'warning');
                    return;
                }
                if (State.pendingRejectId) {
                    await rejectPartner(State.pendingRejectId, reason);
                    document.getElementById('rejectReasonModal').classList.remove('show');
                    State.pendingRejectId = null;
                    document.getElementById('rejectReasonInput').value = '';
                }
            });
            
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('show');
                        if (modal.id === 'rejectReasonModal') {
                            State.pendingRejectId = null;
                            document.getElementById('rejectReasonInput').value = '';
                        }
                    }
                });
            });
        }

        function updateAdminInfo() {
            if (State.currentUser) {
                const avatar = getInitials(State.currentUser.full_name || 'Admin');
                document.getElementById('adminAvatar').textContent = avatar;
                document.getElementById('topbarAvatar').textContent = avatar;
                document.getElementById('adminName').textContent = State.currentUser.full_name || 'Admin User';
                document.getElementById('adminEmail').textContent = State.currentUser.email || 'admin@footman.com';
            }
        }

        // ========== USER ACTIONS ==========
        async function viewUserDetails(userId) {
            try {
                const result = await apiRequest(`/admin/users?limit=100`);
                if (!result?.success) return;
                
                const user = result.data.users.find(u => u.id === userId);
                if (!user) {
                    showToast('User not found', 'error');
                    return;
                }
                
                document.getElementById('modalTitle').textContent = `${user.full_name || 'User'} Details`;
                
                const modalBody = document.getElementById('modalBody');
                const modalFooter = document.getElementById('modalFooter');
                
                const userType = user.user_type || 'customer';
                const isActive = user.is_active !== false;
                
                let statusText = '';
                if (isActive) {
                    statusText = '<span class="status-badge status-active"><i class="fas fa-check-circle"></i> Active</span>';
                } else if (user.rejection_reason) {
                    statusText = '<span class="status-badge status-rejected"><i class="fas fa-times-circle"></i> Rejected</span>';
                } else {
                    statusText = '<span class="status-badge status-pending"><i class="fas fa-clock"></i> Pending</span>';
                }
                
                modalBody.innerHTML = `
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">Full Name</span>
                            <div class="detail-value">${user.full_name || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Phone Number</span>
                            <div class="detail-value">${user.phone || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Email</span>
                            <div class="detail-value">${user.email || 'No email'}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">User Type</span>
                            <div class="detail-value">
                                ${userType === 'admin' ? '<i class="fas fa-crown"></i> Admin' : 
                                  userType === 'delivery' ? '<i class="fas fa-truck"></i> Delivery Partner' : 
                                  '<i class="fas fa-user"></i> Customer'}
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status</span>
                            <div class="detail-value">${statusText}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Joined</span>
                            <div class="detail-value">${formatDate(user.created_at)}</div>
                        </div>
                    </div>
                    
                    ${userType === 'delivery' ? `
                        <div class="mt-3">
                            <h3 style="margin-bottom: 16px;">Partner Details</h3>
                            <div class="details-grid">
                                <div class="detail-item">
                                    <span class="detail-label">NID Number</span>
                                    <div class="detail-value">${user.nid_number || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Emergency Contact</span>
                                    <div class="detail-value">
                                        ${user.emergency_contact_name || 'N/A'} 
                                        (${user.emergency_contact_relationship || 'N/A'})<br>
                                        <small>${user.emergency_contact_phone || 'No phone'}</small>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Address</span>
                                    <div class="detail-value">${user.address || 'N/A'}</div>
                                </div>
                                ${user.rejection_reason ? `
                                <div class="detail-item">
                                    <span class="detail-label" style="color: #ef4444;">Rejection Reason</span>
                                    <div class="detail-value" style="color: #ef4444;">
                                        <i class="fas fa-exclamation-triangle"></i> ${user.rejection_reason}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                `;
                
                modalFooter.innerHTML = `
                    ${userType === 'delivery' && !isActive && !user.rejection_reason ? 
                        `<button class="btn btn-success" onclick="approvePartner(${user.id}, true)">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn btn-danger" onclick="openRejectModal(${user.id})">
                            <i class="fas fa-times"></i> Reject
                        </button>` : ''}
                    <button class="btn btn-secondary" onclick="document.getElementById('userModal').classList.remove('show')">
                        Close
                    </button>
                `;
                
                document.getElementById('userModal').classList.add('show');
                
            } catch (error) {
                console.error('Error viewing user:', error);
                showToast('Failed to load user details', 'error');
            }
        }

        async function viewPartnerDocuments(userId) {
            try {
                const result = await apiRequest(`/admin/users?limit=100`);
                if (!result?.success) return;
                
                const partner = result.data.users.find(u => u.id === userId && u.user_type === 'delivery');
                if (!partner) {
                    showToast('Partner not found', 'error');
                    return;
                }
                
                document.getElementById('documentsTitle').textContent = `${partner.full_name || 'Partner'} Documents`;
                
                const documentsBody = document.getElementById('documentsBody');
                const documentsFooter = document.getElementById('documentsFooter');
                
                documentsBody.innerHTML = `
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">Partner Name</span>
                            <div class="detail-value">${partner.full_name || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Phone Number</span>
                            <div class="detail-value">${partner.phone || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">NID Number</span>
                            <div class="detail-value">${partner.nid_number || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status</span>
                            <div class="detail-value">
                                ${partner.is_active ? 
                                    '<span class="status-badge status-active"><i class="fas fa-check-circle"></i> Approved</span>' : 
                                    partner.rejection_reason ?
                                    '<span class="status-badge status-rejected"><i class="fas fa-times-circle"></i> Rejected</span>' :
                                    '<span class="status-badge status-pending"><i class="fas fa-clock"></i> Pending</span>'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h3 style="margin-bottom: 16px;">Documents</h3>
                        <div class="d-flex flex-column gap-3">
                            ${partner.profile_image_url ? `
                                <div class="detail-item">
                                    <span class="detail-label">Profile Photo</span>
                                    <div class="detail-value">
                                        <img src="${partner.profile_image_url}" alt="Profile" style="max-width: 200px; border-radius: 8px;">
                                    </div>
                                </div>
                            ` : '<p class="text-muted">No profile photo uploaded</p>'}
                            
                            ${partner.nid_front_image_url ? `
                                <div class="detail-item">
                                    <span class="detail-label">NID Front</span>
                                    <div class="detail-value">
                                        <img src="${partner.nid_front_image_url}" alt="NID Front" style="max-width: 200px; border-radius: 8px;">
                                    </div>
                                </div>
                            ` : '<p class="text-muted">No NID front uploaded</p>'}
                            
                            ${partner.nid_back_image_url ? `
                                <div class="detail-item">
                                    <span class="detail-label">NID Back</span>
                                    <div class="detail-value">
                                        <img src="${partner.nid_back_image_url}" alt="NID Back" style="max-width: 200px; border-radius: 8px;">
                                    </div>
                                </div>
                            ` : '<p class="text-muted">No NID back uploaded</p>'}
                        </div>
                    </div>
                `;
                
                documentsFooter.innerHTML = `
                    ${!partner.is_active && !partner.rejection_reason ? `
                        <button class="btn btn-success" onclick="approvePartner(${partner.id}, true)">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn btn-danger" onclick="openRejectModal(${partner.id})">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    ` : ''}
                    <button class="btn btn-secondary" onclick="document.getElementById('documentsModal').classList.remove('show')">
                        Close
                    </button>
                `;
                
                document.getElementById('documentsModal').classList.add('show');
                
            } catch (error) {
                console.error('Error viewing documents:', error);
                showToast('Failed to load documents', 'error');
            }
        }

        async function viewRequestDetails(requestId) {
            try {
                const result = await apiRequest('/admin/requests?limit=200');
                if (!result?.success) return;
                
                const request = result.data.requests.find(r => r.id === requestId);
                if (!request) {
                    showToast('Request not found', 'error');
                    return;
                }
                
                document.getElementById('requestTitle').textContent = `Request ${request.request_number}`;
                
                const requestBody = document.getElementById('requestBody');
                requestBody.innerHTML = `
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">Request Number</span>
                            <div class="detail-value">${request.request_number}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status</span>
                            <div class="detail-value">
                                ${request.request_status === 'completed' ? 
                                    '<span class="status-badge status-completed"><i class="fas fa-check-circle"></i> Completed</span>' :
                                    request.request_status === 'cancelled' ?
                                    '<span class="status-badge status-rejected"><i class="fas fa-times-circle"></i> Cancelled</span>' :
                                    '<span class="status-badge status-pending"><i class="fas fa-clock"></i> Pending</span>'}
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Customer</span>
                            <div class="detail-value">
                                <div class="user-cell">
                                    <div class="avatar">
                                        ${request.customer?.profile_image_url ? 
                                            `<img src="${request.customer.profile_image_url}" alt="${request.customer.full_name}">` : 
                                            getInitials(request.customer?.full_name)}
                                    </div>
                                    <div class="user-info">
                                        <div class="user-name">${request.customer?.full_name || 'Unknown'}</div>
                                        <div class="user-email">${request.customer?.phone || ''}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Partner</span>
                            <div class="detail-value">
                                ${request.footman ? `
                                    <div class="user-cell">
                                        <div class="avatar">
                                            ${request.footman.profile_image_url ? 
                                                `<img src="${request.footman.profile_image_url}" alt="${request.footman.full_name}">` : 
                                                getInitials(request.footman.full_name)}
                                        </div>
                                        <div class="user-info">
                                            <div class="user-name">${request.footman.full_name}</div>
                                            <div class="user-email">${request.footman.phone}</div>
                                        </div>
                                    </div>
                                ` : 'Not assigned'}
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Amount</span>
                            <div class="detail-value"><strong>${formatCurrency(request.base_price)}</strong></div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Commission</span>
                            <div class="detail-value">${formatCurrency(request.commission)}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Payment Method</span>
                            <div class="detail-value">${request.customer_selected_payment || 'Not selected'}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Created</span>
                            <div class="detail-value">${formatDateTime(request.created_at)}</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('requestFooter').innerHTML = `
                    <button class="btn btn-secondary" onclick="document.getElementById('requestModal').classList.remove('show')">
                        Close
                    </button>
                `;
                
                document.getElementById('requestModal').classList.add('show');
                
            } catch (error) {
                console.error('Error viewing request:', error);
                showToast('Failed to load request details', 'error');
            }
        }

        function openRejectModal(userId) {
            State.pendingRejectId = userId;
            document.getElementById('rejectReasonInput').value = '';
            document.getElementById('rejectReasonModal').classList.add('show');
        }

        async function rejectPartner(userId, reason) {
            try {
                setLoading(true);
                
                const result = await apiRequest(`/admin/partners/${userId}/reject`, {
                    method: 'PUT',
                    body: JSON.stringify({ reason })
                });
                
                if (result?.success) {
                    showToast('Partner rejected successfully!', 'success');
                    document.getElementById('userModal').classList.remove('show');
                    document.getElementById('documentsModal').classList.remove('show');
                    loadPage(State.currentPage);
                    
                    const dashboard = await apiRequest('/admin/dashboard');
                    if (dashboard?.success) {
                        document.getElementById('pendingBadge').textContent = dashboard.data.stats.pending_approvals || 0;
                        document.getElementById('rejectedBadge').textContent = dashboard.data.stats.rejected_partners || 0;
                    }
                } else {
                    throw new Error(result?.message || 'Failed to reject partner');
                }
            } catch (error) {
                console.error('Reject partner error:', error);
                showToast(`Failed to reject partner: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        }

        async function approvePartner(userId, fromModal = false) {
            if (!confirm('Are you sure you want to approve this partner?')) return;
            
            try {
                setLoading(true);
                
                const result = await apiRequest(`/admin/partners/${userId}/approve`, {
                    method: 'PUT'
                });
                
                if (result?.success) {
                    showToast('Partner approved successfully!', 'success');
                    
                    if (fromModal) {
                        document.getElementById('userModal').classList.remove('show');
                        document.getElementById('documentsModal').classList.remove('show');
                    }
                    
                    loadPage(State.currentPage);
                    
                    const dashboard = await apiRequest('/admin/dashboard');
                    if (dashboard?.success) {
                        document.getElementById('pendingBadge').textContent = dashboard.data.stats.pending_approvals || 0;
                    }
                } else {
                    throw new Error(result?.message || 'Failed to approve partner');
                }
            } catch (error) {
                console.error('Approve partner error:', error);
                showToast(`Failed to approve partner: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        }

        // ========== AUTO REFRESH ==========
        let refreshInterval;
        
        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(() => {
                if (State.currentPage === 'dashboard') {
                    loadDashboard();
                }
            }, Config.REFRESH_INTERVAL);
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', () => {
            setupNavigation();
            initAuth();
        });
    </script>
</body>
</html>

const Order = require('../models/Order');
const Address = require('../models/Address');
const User = require('../models/User');

exports.createOrder = async (req, res) => {
  try {
    const { 
      store_name, 
      store_address, 
      items_description, 
      estimated_amount,
      delivery_address_id,
      delivery_instructions,
      payment_method,
      pickup_lat,
      pickup_lng,
      delivery_lat,
      delivery_lng
    } = req.body;

    const customer_id = req.user.id;

    // Generate order number
    const order_number = Order.generateOrderNumber();

    // Create order with location data
    const order = await Order.create({
      order_number,
      customer_id,
      store_name,
      store_address,
      items_description,
      estimated_amount,
      delivery_instructions,
      payment_method,
      pickup_lat: pickup_lat || null,
      pickup_lng: pickup_lng || null,
      delivery_lat: delivery_lat || null,
      delivery_lng: delivery_lng || null,
      order_status: 'pending',
      payment_status: 'pending'
    });

    res.status(201).json({
      success: true,
      message: 'Order created successfully',
      data: { order }
    });
  } catch (error) {
    console.error('Create order error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to create order',
      error: error.message
    });
  }
};

exports.getCustomerOrders = async (req, res) => {
  try {
    const customer_id = req.user.id;
    const { status } = req.query;

    const where = { customer_id };
    if (status) {
      where.order_status = status;
    }

    const orders = await Order.findAll({
      where,
      order: [['created_at', 'DESC']],
      include: [
        { 
          model: User, 
          as: 'delivery_boy',
          attributes: ['id', 'full_name', 'phone']
        }
      ]
    });

    res.status(200).json({
      success: true,
      data: { orders }
    });
  } catch (error) {
    console.error('Get orders error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to fetch orders',
      error: error.message
    });
  }
};

exports.getOrderDetails = async (req, res) => {
  try {
    const { id } = req.params;
    const customer_id = req.user.id;

    const order = await Order.findOne({
      where: { id, customer_id },
      include: [
        { 
          model: User, 
          as: 'delivery_boy',
          attributes: ['id', 'full_name', 'phone']
        },
        { 
          model: User, 
          as: 'customer',
          attributes: ['id', 'full_name', 'phone']
        }
      ]
    });

    if (!order) {
      return res.status(404).json({
        success: false,
        message: 'Order not found'
      });
    }

    res.status(200).json({
      success: true,
      data: { order }
    });
  } catch (error) {
    console.error('Get order details error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to fetch order details',
      error: error.message
    });
  }
};

exports.cancelOrder = async (req, res) => {
  try {
    const { id } = req.params;
    const customer_id = req.user.id;

    const order = await Order.findOne({ where: { id, customer_id } });

    if (!order) {
      return res.status(404).json({
        success: false,
        message: 'Order not found'
      });
    }

    // Only allow cancellation if order is still pending
    if (order.order_status !== 'pending') {
      return res.status(400).json({
        success: false,
        message: 'Order cannot be cancelled at this stage'
      });
    }

    order.order_status = 'cancelled';
    await order.save();

    res.status(200).json({
      success: true,
      message: 'Order cancelled successfully',
      data: { order }
    });
  } catch (error) {
    console.error('Cancel order error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to cancel order',
      error: error.message
    });
  }
};

exports.updateOrderStatus = async (req, res) => {
  try {
    const { id } = req.params;
    const { status } = req.body;
    const delivery_boy_id = req.user.id;

    // Check if user is a delivery boy
    const user = await User.findByPk(delivery_boy_id);
    if (user.user_type !== 'delivery') {
      return res.status(403).json({
        success: false,
        message: 'Only delivery boys can update order status'
      });
    }

    const order = await Order.findOne({ 
      where: { id, delivery_boy_id } 
    });

    if (!order) {
      return res.status(404).json({
        success: false,
        message: 'Order not found'
      });
    }

    // Update status and timestamps
    order.order_status = status;
    
    if (status === 'accepted') {
      order.accepted_at = new Date();
    } else if (status === 'picked_up') {
      order.picked_up_at = new Date();
    } else if (status === 'delivered') {
      order.delivered_at = new Date();
    }

    await order.save();

    res.status(200).json({
      success: true,
      message: 'Order status updated successfully',
      data: { order }
    });
  } catch (error) {
    console.error('Update order status error:', error);
    res.status(500).json({
      success: false,
      message: 'Failed to update order status',
      error: error.message
    });
  }
};

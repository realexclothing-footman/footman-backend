<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOOTMAN Business Admin</title>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Maps for location display -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzyphoov_MRg7ELNMbNmyApIVcuz3YPss&callback=initMap" async defer></script>
    <style>
        /* ========== VARIABLES ========== */
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --light: #f8fafc;
            --dark: #1e293b;
            --sidebar: #1e293b;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --bg-main: #f1f5f9;
            --hover-bg: rgba(0, 0, 0, 0.05);
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        /* Dark mode */
        [data-theme="dark"] {
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --light: #1e293b;
            --dark: #f8fafc;
            --sidebar: #0f172a;
            --card-bg: #1e293b;
            --border: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --bg-main: #0f172a;
            --hover-bg: rgba(255, 255, 255, 0.05);
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
            --transition: all 0.3s ease;
        }
            --danger: #ef4444;
            --info: #3b82f6;
            --light: #1e293b;
            --dark: #f8fafc;
            --sidebar: #0f172a;
            --card-bg: #1e293b;
            --border: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --bg-main: #0f172a;
            --hover-bg: rgba(255, 255, 255, 0.05);
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
            --transition: all 0.3s ease;
        }
        /* ========== RESET & BASE ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ========== LAYOUT ========== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* ========== SIDEBAR ========== */
        .sidebar {
            width: 280px;
            background: var(--sidebar);
            color: white;
            padding: 24px 0;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            z-index: 100;
        }

        .sidebar-header {
            padding: 0 24px 32px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--primary);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
        }

        .logo-text h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .logo-text span {
            font-size: 12px;
            opacity: 0.7;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255, 255, 255, 0.5);
            padding: 0 24px 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 24px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: var(--transition);
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            position: relative;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            padding-left: 28px;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            border-left: 4px solid white;
        }

        .nav-badge {
            margin-left: auto;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            min-width: 24px;
            text-align: center;
        }

        .badge-success { background: var(--success); color: white; }
        .badge-warning { background: var(--warning); color: white; }
        .badge-danger { background: var(--danger); color: white; }
        .badge-info { background: var(--info); color: white; }

        .sidebar-footer {
            margin-top: auto;
            padding: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ========== MAIN CONTENT ========== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .topbar {
            background: var(--card-bg);
            padding: 0 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 72px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
        }

        .menu-toggle:hover {
            background: var(--light);
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }


        .theme-toggle {
            background: var(--hover-bg);
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-primary);
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .theme-toggle i {
            font-size: 18px;
        }
        .user-menu {

        .theme-toggle {
            background: var(--hover-bg);
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-primary);
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .theme-toggle i {
            font-size: 18px;
        }
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            font-size: 16px;
        }

        /* ========== CONTENT AREA ========== */
        .content-wrapper {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
            margin-top: 8px;
        }

        /* ========== STATS GRID ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border-top: 4px solid var(--primary);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            color: white;
            font-size: 24px;
        }

        .stat-content h3 {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1;
        }

        .stat-change {
            font-size: 14px;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-change.negative {
            color: var(--danger);
        }

        /* ========== CHARTS ========== */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .chart-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        /* ========== DATA TABLES ========== */
        .data-section {
            margin-bottom: 32px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .section-actions {
            display: flex;
            gap: 12px;
        }

        .data-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .card-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-tools {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            transition: var(--transition);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .filter-select {
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--card-bg);
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            min-width: 150px;
        }

        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .data-table th {
            background: var(--light);
            padding: 18px 24px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .data-table td {
            padding: 18px 24px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
            font-size: 14px;
        }

        .data-table tr {
            transition: var(--transition);
        }

        .data-table tr:hover {
            background: var(--light);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* ========== STATUS BADGES ========== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-active { background: #d1fae5; color: #065f46; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-rejected { background: #fee2e2; color: #991b1b; }
        .status-inactive { background: #fee2e2; color: #991b1b; }
        .status-online { background: #d1fae5; color: #065f46; }
        .status-offline { background: var(--bg-main); color: #64748b; }
        .status-completed { background: #dbeafe; color: #1e40af; }
        .status-ongoing { background: #f3e8ff; color: #6b21a8; }

        /* Dark mode badge adjustments */
        [data-theme="dark"] .status-active { background: #064e3b; color: #d1fae5; }
        [data-theme="dark"] .status-pending { background: #78350f; color: #fef3c7; }
        [data-theme="dark"] .status-rejected { background: #7f1d1d; color: #fee2e2; }
        [data-theme="dark"] .status-inactive { background: #334155; color: #f1f5f9; }
        [data-theme="dark"] .status-online { background: #064e3b; color: #d1fae5; }
        [data-theme="dark"] .status-offline { background: #334155; color: #f1f5f9; }
        [data-theme="dark"] .status-completed { background: #1e3a8a; color: #dbeafe; }
        [data-theme="dark"] .status-ongoing { background: #581c87; color: #f3e8ff; }

        /* Dark mode badge adjustments */
        [data-theme="dark"] .status-active { background: #064e3b; color: #d1fae5; }
        [data-theme="dark"] .status-pending { background: #78350f; color: #fef3c7; }
        [data-theme="dark"] .status-inactive { background: #7f1d1d; color: #fee2e2; }
        [data-theme="dark"] .status-online { background: #064e3b; color: #d1fae5; }
        [data-theme="dark"] .status-offline { background: #334155; color: #f1f5f9; }
        [data-theme="dark"] .status-completed { background: #1e3a8a; color: #dbeafe; }
        [data-theme="dark"] .status-ongoing { background: #581c87; color: #f3e8ff; }

        /* Dark mode badge adjustments */
        [data-theme="dark"] .status-active { background: #064e3b; color: #d1fae5; }
        [data-theme="dark"] .status-pending { background: #78350f; color: #fef3c7; }
        [data-theme="dark"] .status-rejected { background: #7f1d1d; color: #fee2e2; }
        [data-theme="dark"] .status-inactive { background: #334155; color: #f1f5f9; }
        [data-theme="dark"] .status-online { background: #064e3b; color: #d1fae5; }
        [data-theme="dark"] .status-offline { background: #334155; color: #f1f5f9; }
        [data-theme="dark"] .status-completed { background: #1e3a8a; color: #dbeafe; }
        [data-theme="dark"] .status-ongoing { background: #581c87; color: #f3e8ff; }

        /* ========== USER AVATAR ========== */
        .user-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            flex-shrink: 0;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .user-email {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* ========== BUTTONS ========== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(16, 185, 129, 0.05);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-icon {
            padding: 8px;
            width: 36px;
            height: 36px;
            justify-content: center;
        }

        /* ========== LOGIN SCREEN ========== */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 10000;
        }

        .login-box {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: loginFadeIn 0.5s ease;
        }

        @keyframes loginFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: var(--primary);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 32px;
            color: white;
            margin: 0 auto 20px;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 16px;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .login-info {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .login-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        /* ========== MODAL ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--radius);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--card-bg);
            z-index: 10;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .close-btn:hover {
            background: var(--light);
            color: var(--danger);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            position: sticky;
            bottom: 0;
            background: var(--card-bg);
        }

        /* ========== DETAILS VIEW ========== */
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .detail-item {
            padding: 20px;
            background: var(--light);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .detail-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: block;
        }

        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.4;
        }

        /* ========== DOCUMENTS TABLE VIEW ========== */
        .documents-table-view {
            width: 100%;
        }

        .document-row {
            border-bottom: 1px solid var(--border);
            padding: 16px 0;
        }

        .document-row:last-child {
            border-bottom: none;
        }

        .document-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .document-thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .document-details {
            flex: 1;
        }

        .document-actions {
            display: flex;
            gap: 8px;
        }

        /* ========== LOADING & EMPTY STATES ========== */
        .loading {
            text-align: center;
            padding: 60px 24px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 24px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-description {
            font-size: 14px;
            max-width: 400px;
            margin: 0 auto;
        }

        /* ========== PAGINATION ========== */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 24px;
            border-top: 1px solid var(--border);
        }

        .page-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            font-weight: 500;
        }

        .page-btn:hover:not(.active) {
            background: var(--light);
            border-color: var(--primary);
        }

        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* ========== TOAST NOTIFICATIONS ========== */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }

        .toast {
            background: var(--card-bg);
            border-left: 4px solid var(--success);
            border-radius: var(--radius);
            padding: 16px 20px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            animation: slideInRight 0.3s ease;
            transform: translateX(0);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-error { border-left-color: var(--danger); }
        .toast-warning { border-left-color: var(--warning); }
        .toast-info { border-left-color: var(--info); }

        .toast-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            flex: 1;
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0 0 0 16px;
            opacity: 0.7;
            transition: var(--transition);
        }

        .toast-close:hover {
            opacity: 1;
            color: var(--text-primary);
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 1200px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                bottom: 0;
                transition: var(--transition);
            }
            
            .sidebar.show {
                left: 0;
                box-shadow: 0 0 50px rgba(0, 0, 0, 0.3);
            }
            
            .menu-toggle {
                display: block;
            }
            
            .main-content {
                width: 100%;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .search-box {
                width: 200px;
            }
        }

        @media (max-width: 768px) {
            .content-wrapper {
                padding: 20px;
            }
            
            .topbar {
                padding: 0 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .card-header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .card-tools {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                width: 100%;
            }
            
            .section-header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .section-actions {
                flex-wrap: wrap;
            }
            
            .modal-content {
                margin: 10px;
            }
        }

        @media (max-width: 480px) {
            .details-grid {
                grid-template-columns: 1fr;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .modal-footer {
                flex-direction: column;
            }
        }

        /* ========== UTILITY CLASSES ========== */
        .d-none { display: none !important; }
        .d-flex { display: flex; }
        .d-block { display: block; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 12px; }
        .gap-4 { gap: 24px; }
        .mt-3 { margin-top: 24px; }
        .mb-3 { margin-bottom: 24px; }
        .ml-auto { margin-left: auto; }
        .text-center { text-align: center; }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .text-muted { color: var(--text-secondary); }
    </style>
</head>
<body data-theme="light">
    <!-- Login Screen (Shows first if not logged in) -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-header">
                <div class="login-logo">F</div>
                <h1 class="login-title">FOOTMAN Admin</h1>
                <p class="login-subtitle">Business Administration Panel</p>
            </div>
            
            <div class="login-info">
                üí° <strong>Default Admin Credentials:</strong><br>
                Phone: <code>01700000000</code><br>
                Password: <code>admin123</code>
            </div>
            
            <div class="form-group">
                <label class="form-label">Phone Number</label>
                <input type="tel" id="loginPhone" class="form-control" value="01700000000" placeholder="Enter phone number">
            </div>
            
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="loginPassword" class="form-control" placeholder="Enter password">
            </div>
            
            <div class="login-error" id="loginError"></div>
            
            <button class="btn btn-primary" id="loginBtn" style="width: 100%; padding: 16px; font-size: 16px;">
                üîí Login to Admin Panel
            </button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Main App Container (Hidden until login) -->
    <div class="app-container d-none" id="appContainer">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">F</div>
                    <div class="logo-text">
                        <h2>FOOTMAN</h2>
                        <span>Business Admin</span>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="nav-menu">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <button class="nav-item active" data-page="dashboard">
                        üìä Dashboard
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">User Management</div>
                    <button class="nav-item" data-page="users">
                        üë• All Users
                        <span class="nav-badge badge-info" id="usersBadge">0</span>
                    </button>
                    <button class="nav-item" data-page="partners">
                        üöö Delivery Partners
                        <span class="nav-badge badge-success" id="partnersBadge">0</span>
                    </button>
                    <button class="nav-item" data-page="customers">
                        üë§ Customers
                        <span class="nav-badge badge-info" id="customersBadge">0</span>
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Business Operations</div>
                    <button class="nav-item" data-page="requests">
                        üì¶ Delivery Requests
                        <span class="nav-badge badge-warning" id="requestsBadge">0</span>
                    </button>
                    <button class="nav-item" data-page="earnings">
                        üí∞ Earnings & Reports
                    </button>
                    <button class="nav-item" data-page="online">
                        üìç Online Partners
                        <span class="nav-badge badge-success" id="onlineBadge">0</span>
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Verification</div>
                    <button class="nav-item" data-page="pending">
                        ‚è≥ Pending Approvals
                        <span class="nav-badge badge-danger" id="pendingBadge">0</span>
                    </button>
                    <button class="nav-item" data-page="rejected">
                        ‚ùå Rejected Partners
                        <span class="nav-badge badge-danger" id="rejectedBadge">0</span>
                    </button>
                    <button class="nav-item" data-page="documents">
                        üìÑ Document Verification
                    </button>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-menu">
                    <div class="user-avatar" id="adminAvatar">A</div>
                    <div>
                        <div class="user-name">Admin User</div>
                        <div class="user-email">admin@footman.com</div>
                    </div>
                </div>
                <button class="btn btn-secondary btn-sm mt-3" id="logoutBtn" style="width: 100%;">
                    üö™ Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="topbar">
                <div class="topbar-left">
                    <button class="menu-toggle" id="menuToggle">‚ò∞</button>
                    <h1 class="page-title" id="pageTitle">Dashboard</h1>
                </div>
                    <!-- Theme Toggle Button -->
                    <div class="theme-toggle" id="themeToggle">
                        <span id="themeIcon">‚òÄÔ∏è</span>
                        <span id="themeText">Light</span>
                    </div>                    <div class="user-menu">
                        <span id="currentTime"></span>
                        <div class="user-avatar" id="topbarAvatar">A</div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-wrapper">
                <!-- Dashboard Page -->
                <section class="page-content" id="dashboardPage">
                    <div class="page-header">
                        <h1 class="page-title">Business Dashboard</h1>
                        <p class="page-subtitle">Real-time overview of your delivery business</p>
                    </div>

                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üí∞</div>
                            <div class="stat-content">
                                <h3>Total Revenue</h3>
                                <div class="stat-value" id="totalRevenue">‡ß≥ 0</div>
                                <div class="stat-change" id="revenueChange">
                                    <span>‚Üó</span> Loading...
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">üè¶</div>
                            <div class="stat-content">
                                <h3>Your Commission</h3>
                                <div class="stat-value" id="totalCommission">‡ß≥ 0</div>
                                <div class="stat-change">
                                    <span>‚Üó</span> 10% of revenue
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">üë•</div>
                            <div class="stat-content">
                                <h3>Total Users</h3>
                                <div class="stat-value" id="totalUsers">0</div>
                                <div class="stat-change">
                                    <span>‚Üó</span> <span id="onlinePartners">0</span> partners online
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">üì¶</div>
                            <div class="stat-content">
                                <h3>Total Requests</h3>
                                <div class="stat-value" id="totalRequests">0</div>
                                <div class="stat-change">
                                    <span>‚Üó</span> <span id="todayRequests">0</span> today
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">üöö</div>
                            <div class="stat-content">
                                <h3>Delivery Partners</h3>
                                <div class="stat-value" id="totalPartners">0</div>
                                <div class="stat-change">
                                    <span>‚Üó</span> <span id="activePartners">0</span> active
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">üë§</div>
                            <div class="stat-content">
                                <h3>Customers</h3>
                                <div class="stat-value" id="totalCustomers">0</div>
                                <div class="stat-change">
                                    <span>‚Üó</span> All time
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Revenue Overview</h3>
                                <select class="filter-select" id="revenuePeriod">
                                    <option value="7days">Last 7 Days</option>
                                    <option value="30days">Last 30 Days</option>
                                    <option value="90days">Last 90 Days</option>
                                </select>
                            </div>
                            <div class="chart-container">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Request Status Distribution</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="requestsChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="data-section">
                        <div class="section-header">
                            <h3 class="section-title">Recent Delivery Requests</h3>
                            <div class="section-actions">
                                <button class="btn btn-outline btn-sm" id="refreshActivity">
                                    üîÑ Refresh
                                </button>
                            </div>
                        </div>
                        <div class="data-card">
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Request #</th>
                                            <th>Customer</th>
                                            <th>Partner</th>
                                            <th>Status</th>
                                            <th>Amount</th>
                                            <th>Commission</th>
                                            <th>Created</th>
                                        </tr>
                                    </thead>
                                    <tbody id="activityTable">
                                        <tr>
                                            <td colspan="7" class="loading">
                                                <div class="loading-spinner"></div>
                                                <p>Loading recent requests...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- All Users Page -->
                <section class="page-content d-none" id="usersPage">
                    <div class="page-header">
                        <h1 class="page-title">User Management</h1>
                        <p class="page-subtitle">Manage all user accounts in the system</p>
                    </div>

                    <div class="data-card">
                        <div class="card-header">
                            <h3 class="card-title">All Users</h3>
                            <div class="card-tools">
                                <div class="search-box">
                                    <span class="search-icon">üîç</span>
                                    <input type="text" id="userSearch" placeholder="Search users..." onkeyup="searchUsers()">
                                </div>
                                <select class="filter-select" id="userTypeFilter" onchange="filterUsers()">
                                    <option value="">All Types</option>
                                    <option value="admin">Admin</option>
                                    <option value="delivery">Delivery Partner</option>
                                    <option value="customer">Customer</option>
                                </select>
                                <select class="filter-select" id="userStatusFilter" onchange="filterUsers()">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="pending">Pending</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                                <select class="filter-select" id="userOnlineFilter" onchange="filterUsers()">
                                    <option value="">All Online</option>
                                    <option value="true">Online</option>
                                    <option value="false">Offline</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>User</th>
                                        <th>Contact</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Online</th>
                                        <th>Joined</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable">
                                    <tr>
                                        <td colspan="8" class="loading">
                                            <div class="loading-spinner"></div>
                                            <p>Loading users...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="usersPagination"></div>
                    </div>
                </section>

                <!-- Delivery Partners Page -->
                <section class="page-content d-none" id="partnersPage">
                    <div class="page-header">
                        <h1 class="page-title">Delivery Partners</h1>
                        <p class="page-subtitle">Manage and monitor delivery partners</p>
                    </div>

                    <div class="data-card">
                        <div class="card-header">
                            <h3 class="card-title">Delivery Partners</h3>
                            <div class="card-tools">
                                <div class="search-box">
                                    <span class="search-icon">üîç</span>
                                    <input type="text" id="partnerSearch" placeholder="Search partners..." onkeyup="searchPartners()">
                                </div>
                                <select class="filter-select" id="partnerStatusFilter" onchange="filterPartners()">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="pending">Pending</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                                <select class="filter-select" id="partnerOnlineFilter" onchange="filterPartners()">
                                    <option value="">All Online</option>
                                    <option value="true">Online</option>
                                    <option value="false">Offline</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Partner</th>
                                        <th>Contact</th>
                                        <th>NID</th>
                                        <th>Status</th>
                                        <th>Rejection Reason</th>
                                        <th>Online</th>
                                        <th>Location</th>
                                        <th>Rating</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="partnersTable">
                                    <tr>
                                        <td colspan="9" class="loading">
                                            <div class="loading-spinner"></div>
                                            <p>Loading partners...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="partnersPagination"></div>
                    </div>

                    <!-- Partner Documents Section -->
                    <div class="data-section mt-3">
                        <div class="section-header">
                            <h3 class="section-title">Document Verification Queue</h3>
                        </div>
                        <div class="data-card">
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Partner</th>
                                            <th>Documents Status</th>
                                            <th>NID Verified</th>
                                            <th>Applied</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="documentsTable">
                                        <tr>
                                            <td colspan="5" class="loading">
                                                <div class="loading-spinner"></div>
                                                <p>Loading documents...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Customers Page -->
                <section class="page-content d-none" id="customersPage">
                    <div class="page-header">
                        <h1 class="page-title">Customers</h1>
                        <p class="page-subtitle">Manage customer accounts and view activity</p>
                    </div>

                    <div class="data-card">
                        <div class="card-header">
                            <h3 class="card-title">All Customers</h3>
                            <div class="card-tools">
                                <div class="search-box">
                                    <span class="search-icon">üîç</span>
                                    <input type="text" id="customerSearch" placeholder="Search customers..." onkeyup="searchCustomers()">
                                </div>
                                <select class="filter-select" id="customerStatusFilter" onchange="filterCustomers()">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Customer</th>
                                        <th>Contact</th>
                                        <th>Profile Photo</th>
                                        <th>Total Orders</th>
                                        <th>Total Spent</th>
                                        <th>Last Order</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="customersTable">
                                    <tr>
                                        <td colspan="8" class="loading">
                                            <div class="loading-spinner"></div>
                                            <p>Loading customers...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="customersPagination"></div>
                    </div>
                </section>

                <!-- Delivery Requests Page -->
                <section class="page-content d-none" id="requestsPage">
                    <div class="page-header">
                        <h1 class="page-title">Delivery Requests</h1>
                        <p class="page-subtitle">Monitor and manage all delivery requests</p>
                    </div>

                    <div class="data-card">
                        <div class="card-header">
                            <h3 class="card-title">All Requests</h3>
                            <div class="card-tools">
                                <div class="search-box">
                                    <span class="search-icon">üîç</span>
                                    <input type="text" id="requestSearch" placeholder="Search requests..." onkeyup="searchRequests()">
                                </div>
                                <select class="filter-select" id="requestStatusFilter" onchange="filterRequests()">
                                    <option value="">All Status</option>
                                    <option value="searching">Searching</option>
                                    <option value="accepted">Accepted</option>
                                    <option value="accepted_by_partner">Accepted by Partner</option>
                                    <option value="ongoing">Ongoing</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                                <select class="filter-select" id="requestDateFilter" onchange="filterRequests()">
                                    <option value="">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Request #</th>
                                        <th>Customer</th>
                                        <th>Partner</th>
                                        <th>Status</th>
                                        <th>Amount</th>
                                        <th>Commission</th>
                                        <th>Payment</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="requestsTable">
                                    <tr>
                                        <td colspan="9" class="loading">
                                            <div class="loading-spinner"></div>
                                            <p>Loading requests...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="requestsPagination"></div>
                    </div>
                </section>

                <!-- Earnings Page -->
                <section class="page-content d-none" id="earningsPage">
                    <div class="page-header">
                        <h1 class="page-title">Earnings & Reports</h1>
                        <p class="page-subtitle">Financial overview and business reports</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üí∞</div>
                            <div class="stat-content">
                                <h3>Total Revenue</h3>
                                <div class="stat-value" id="earningsRevenue">‡ß≥ 0</div>
                                <div class="stat-change">All time</div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">üè¶</div>
                            <div class="stat-content">
                                <h3>Your Commission</h3>
                                <div class="stat-value" id="earningsCommission">‡ß≥ 0</div>
                                <div class="stat-change">10% of revenue</div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">üöö</div>
                            <div class="stat-content">
                                <h3>Partner Earnings</h3>
                                <div class="stat-value" id="earningsPartner">‡ß≥ 0</div>
                                <div class="stat-change">90% of revenue</div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">üìä</div>
                            <div class="stat-content">
                                <h3>Success Rate</h3>
                                <div class="stat-value" id="successRate">0%</div>
                                <div class="stat-change">Completed/Total</div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Methods -->
                    <div class="data-section">
                        <div class="section-header">
                            <h3 class="section-title">Payment Methods</h3>
                            <select class="filter-select" id="earningsPeriod" onchange="loadEarnings()">
                                <option value="all">All Time</option>
                                <option value="month">This Month</option>
                                <option value="week">This Week</option>
                                <option value="today">Today</option>
                            </select>
                        </div>
                        <div class="data-card">
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Payment Method</th>
                                            <th>Total Requests</th>
                                            <th>Total Amount</th>
                                            <th>Commission</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentsTable">
                                        <tr>
                                            <td colspan="5" class="loading">
                                                <div class="loading-spinner"></div>
                                                <p>Loading payment data...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Transaction History -->
                    <div class="data-section">
                        <div class="section-header">
                            <h3 class="section-title">Recent Transactions</h3>
                            <button class="btn btn-outline btn-sm" id="exportEarnings">
                                üìä Export Report
                            </button>
                        </div>
                        <div class="data-card">
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Request #</th>
                                            <th>Customer</th>
                                            <th>Partner</th>
                                            <th>Amount</th>
                                            <th>Commission</th>
                                            <th>Method</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactionsTable">
                                        <tr>
                                            <td colspan="8" class="loading">
                                                <div class="loading-spinner"></div>
                                                <p>Loading transactions...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Online Partners Page -->
                <section class="page-content d-none" id="onlinePage">
                    <div class="page-header">
                        <h1 class="page-title">Online Partners</h1>
                        <p class="page-subtitle">Partners currently available for deliveries with GPS locations</p>
                    </div>

                    <div class="data-card">
                        <div class="card-header">
                            <h3 class="card-title">Currently Online with GPS</h3>
                            <div class="card-tools">
                                <button class="btn btn-outline btn-sm" id="refreshOnline">
                                    üîÑ Refresh Locations
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Partner</th>
                                        <th>Status</th>
                                        <th>Active Jobs</th>
                                        <th>GPS Location</th>
                                        <th>Last Update</th>
                                        <th>Rating</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="onlineTable">
                                    <tr>
                                        <td colspan="7" class="loading">
                                            <div class="loading-spinner"></div>
                                            <p>Loading online partners...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="onlinePagination"></div>
                    </div>

                    <!-- Map View with Custom FOOTMAN Marker -->
                    <div class="data-section mt-3">
                        <div class="section-header">
                            <h3 class="section-title">Partner Locations Map</h3>
                        </div>
                        <div class="data-card">
                            <div id="mapContainer" style="height: 500px; background: var(--light); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <p>Loading map...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Pending Approvals Page -->
                <section class="page-content d-none" id="pendingPage">
                    <div class="page-header">
                        <h1 class="page-title">Pending Approvals</h1>
                        <p class="page-subtitle">Approve or reject new delivery partners</p>
                    </div>

                    <div class="data-card">
                        <div class="card-header">
                            <h3 class="card-title">Partners Awaiting Approval</h3>
                            <div class="card-tools">
                                <div class="search-box">
                                    <span class="search-icon">üîç</span>
                                    <input type="text" id="pendingSearch" placeholder="Search pending partners..." onkeyup="searchPending()">
                                </div>
                                <button class="btn btn-outline btn-sm" id="refreshPending">
                                    üîÑ Refresh
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Applicant</th>
                                        <th>Applied</th>
                                        <th>Documents Status</th>
                                        <th>NID Verified</th>
                                        <th>Contact</th>
                                        <th>Emergency Contact</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingTable">
                                    <tr>
                                        <td colspan="7" class="loading">
                                            <div class="loading-spinner"></div>
                                            <p>Loading pending approvals...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="pendingPagination"></div>
                    </div>
                </section>

                <!-- Rejected Partners Page (NEW) -->
                <section class="page-content d-none" id="rejectedPage">
                    <div class="page-header">
                        <h1 class="page-title">Rejected Partners</h1>
                        <p class="page-subtitle">Partners who were rejected with reasons</p>
                    </div>

                    <div class="data-card">
                        <div class="card-header">
                            <h3 class="card-title">Rejected Partners</h3>
                            <div class="card-tools">
                                <div class="search-box">
                                    <span class="search-icon">üîç</span>
                                    <input type="text" id="rejectedSearch" placeholder="Search rejected partners..." onkeyup="searchRejected()">
                                </div>
                                <button class="btn btn-outline btn-sm" id="refreshRejected">
                                    üîÑ Refresh
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Partner</th>
                                        <th>Contact</th>
                                        <th>NID</th>
                                        <th>Rejection Reason</th>
                                        <th>Rejected By</th>
                                        <th>Rejected On</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="rejectedTable">
                                    <tr>
                                        <td colspan="7" class="loading">
                                            <div class="loading-spinner"></div>
                                            <p>Loading rejected partners...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="rejectedPagination"></div>
                    </div>
                </section>

                <!-- Document Verification Page -->
                <section class="page-content d-none" id="documentsPage">
                    <div class="page-header">
                        <h1 class="page-title">Document Verification</h1>
                        <p class="page-subtitle">Verify partner documents and identity - Professional Table View</p>
                    </div>

                    <div class="data-card">
                        <div class="card-header">
                            <h3 class="card-title">Partner Documents</h3>
                            <div class="card-tools">
                                <div class="search-box">
                                    <span class="search-icon">üîç</span>
                                    <input type="text" id="docSearch" placeholder="Search partners..." onkeyup="searchDocuments()">
                                </div>
                                <select class="filter-select" id="docStatusFilter" onchange="filterDocuments()">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending Review</option>
                                    <option value="verified">Verified</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Partner</th>
                                        <th>Contact</th>
                                        <th>NID Number</th>
                                        <th>Status</th>
                                        <th>Rejection Reason</th>
                                        <th>Applied</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="documentsListView">
                                    <tr>
                                        <td colspan="7" class="loading">
                                            <div class="loading-spinner"></div>
                                            <p>Loading documents...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="documentsPagination"></div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- User Details Modal -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">User Details</h2>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading user details...</p>
                </div>
            </div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <!-- Partner Documents Modal -->
    <div class="modal" id="documentsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="documentsTitle">Partner Documents</h2>
                <button class="close-btn" id="closeDocumentsModal">&times;</button>
            </div>
            <div class="modal-body" id="documentsBody">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading documents...</p>
                </div>
            </div>
            <div class="modal-footer" id="documentsFooter"></div>
        </div>
    </div>

    <!-- Request Details Modal -->
    <div class="modal" id="requestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="requestTitle">Request Details</h2>
                <button class="close-btn" id="closeRequestModal">&times;</button>
            </div>
            <div class="modal-body" id="requestBody">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading request details...</p>
                </div>
            </div>
            <div class="modal-footer" id="requestFooter"></div>
        </div>
    </div>

    <!-- Reject Reason Modal (NEW) -->
    <div class="modal" id="rejectReasonModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Reject Partner</h2>
                <button class="close-btn" id="closeRejectModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Rejection Reason <span style="color: var(--danger);">*</span></label>
                    <textarea id="rejectReasonInput" class="form-control" rows="4" placeholder="Enter detailed reason why this partner is being rejected..." style="resize: vertical;"></textarea>
                    <small style="color: var(--text-secondary); margin-top: 8px; display: block;">
                        This reason will be sent to the partner via push notification and stored in their record.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="confirmRejectBtn">
                    ‚úó Reject Partner
                </button>
                <button class="btn btn-secondary" id="cancelRejectBtn">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION ==========
        const Config = {
            THEME_KEY: 'footman_admin_theme',
            API_BASE: 'https://footman-backend.onrender.com/api/v1',
            TOKEN_KEY: 'footman_admin_token',
            USER_KEY: 'footman_admin_user',
            REFRESH_INTERVAL: 30000,
            THEME_KEY: 'footman_admin_theme',
            ITEMS_PER_PAGE: 20,
            CUSTOM_MARKER_URL: 'https://footman-backend.onrender.com/public/images/markers/footman-marker.png' // Custom FOOTMAN marker
        };

        // ========== STATE MANAGEMENT ==========

        // ========== THEME MANAGEMENT ==========
        function initTheme() {
            const savedTheme = localStorage.getItem(Config.THEME_KEY) || "light";
            document.body.setAttribute("data-theme", savedTheme);
            updateThemeUI(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.body.getAttribute("data-theme");
            const newTheme = currentTheme === "light" ? "dark" : "light";
            
            document.body.setAttribute("data-theme", newTheme);
            localStorage.setItem(Config.THEME_KEY, newTheme);
            updateThemeUI(newTheme);
            
            if (State.charts.revenue) {
                updateChartsTheme();
            }
            if (State.charts.requests) {
                updateChartsTheme();
            }
        }

        function updateThemeUI(theme) {
            const themeIcon = document.getElementById("themeIcon");
            const themeText = document.getElementById("themeText");
            
            if (theme === "dark") {
                themeIcon.textContent = "üåô";
                themeText.textContent = "Dark";
            } else {
                themeIcon.textContent = "‚òÄÔ∏è";
                themeText.textContent = "Light";
            }
        }

        function updateChartsTheme() {
            if (!State.charts.revenue && !State.charts.requests) return;
            
            const isDark = document.body.getAttribute("data-theme") === "dark";
            const gridColor = isDark ? "rgba(255, 255, 255, 0.1)" : "rgba(0, 0, 0, 0.05)";
            
            if (State.charts.revenue) {
                State.charts.revenue.options.scales.y.ticks.color = isDark ? "#94a3b8" : "#64748b";
                State.charts.revenue.options.scales.x.ticks.color = isDark ? "#94a3b8" : "#64748b";
                State.charts.revenue.options.scales.y.grid.color = gridColor;
                State.charts.revenue.options.scales.x.grid.color = gridColor;
                State.charts.revenue.options.plugins.legend.labels.color = isDark ? "#f1f5f9" : "#1e293b";
                State.charts.revenue.update();
            }
            
            if (State.charts.requests) {
                State.charts.requests.options.plugins.legend.labels.color = isDark ? "#f1f5f9" : "#1e293b";
                State.charts.requests.data.datasets[0].borderColor = isDark ? "#1e293b" : "#ffffff";
                State.charts.requests.update();
            }
        }

        // ========== THEME MANAGEMENT ==========
        function initTheme() {
            const savedTheme = localStorage.getItem(Config.THEME_KEY) || "light";
            document.body.setAttribute("data-theme", savedTheme);
            updateThemeUI(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.body.getAttribute("data-theme");
            const newTheme = currentTheme === "light" ? "dark" : "light";
            
            document.body.setAttribute("data-theme", newTheme);
            localStorage.setItem(Config.THEME_KEY, newTheme);
            updateThemeUI(newTheme);
            
            if (State.charts.revenue) {
                updateChartsTheme();
            }
            if (State.charts.requests) {
                updateChartsTheme();
            }
        }

        function updateThemeUI(theme) {
            const themeIcon = document.getElementById("themeIcon");
            const themeText = document.getElementById("themeText");
            
            if (theme === "dark") {
                themeIcon.textContent = "üåô";
                themeText.textContent = "Dark";
            } else {
                themeIcon.textContent = "‚òÄÔ∏è";
                themeText.textContent = "Light";
            }
        }

        function updateChartsTheme() {
            if (!State.charts.revenue && !State.charts.requests) return;
            
            const isDark = document.body.getAttribute("data-theme") === "dark";
            const gridColor = isDark ? "rgba(255, 255, 255, 0.1)" : "rgba(0, 0, 0, 0.05)";
            
            if (State.charts.revenue) {
                State.charts.revenue.options.scales.y.ticks.color = isDark ? "#94a3b8" : "#64748b";
                State.charts.revenue.options.scales.x.ticks.color = isDark ? "#94a3b8" : "#64748b";
                State.charts.revenue.options.scales.y.grid.color = gridColor;
                State.charts.revenue.options.scales.x.grid.color = gridColor;
                State.charts.revenue.options.plugins.legend.labels.color = isDark ? "#f1f5f9" : "#1e293b";
                State.charts.revenue.update();
            }
            
            if (State.charts.requests) {
                State.charts.requests.options.plugins.legend.labels.color = isDark ? "#f1f5f9" : "#1e293b";
                State.charts.requests.data.datasets[0].borderColor = isDark ? "#1e293b" : "#ffffff";
                State.charts.requests.update();
            }
        }
        const State = {
            token: null,
            currentPage: 'dashboard',
            currentUser: null,
            isLoading: false,
            pendingRejectId: null, // Store partner ID for rejection
            charts: {
                revenue: null,
                requests: null
            },
            filters: {
                users: { page: 1, limit: 20 },
                partners: { page: 1, limit: 20 },
                customers: { page: 1, limit: 20 },
                requests: { page: 1, limit: 20 },
                online: { page: 1, limit: 20 },
                pending: { page: 1, limit: 20 },
                rejected: { page: 1, limit: 20 },
                documents: { page: 1, limit: 20 }
            },
            map: null,
            mapMarkers: []
        };

        // ========== AUTHENTICATION ==========
        function initAuth() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get("token");
            
            if (urlToken) {
                State.token = urlToken;
                localStorage.setItem(Config.TOKEN_KEY, urlToken);
                window.history.replaceState({}, document.title, window.location.pathname);
                showApp();
                return;
            }
            
            State.token = localStorage.getItem(Config.TOKEN_KEY);
            
            if (State.token) {
                showApp();
            } else {
                showLogin();
            }
        }
        
        function showLogin() {
            document.getElementById("loginScreen").style.display = "flex";
            document.getElementById("appContainer").classList.add("d-none");
        }
        
        function showApp() {
            document.getElementById("loginScreen").style.display = "none";
            document.getElementById("appContainer").classList.remove("d-none");
            initApp();
        }

        async function login(phone, password) {
            const loginBtn = document.getElementById("loginBtn");
            const originalText = loginBtn.textContent;
            const errorDisplay = document.getElementById("loginError");
            
            try {
                loginBtn.textContent = "Logging in...";
                loginBtn.disabled = true;
                errorDisplay.style.display = "none";
                
                const response = await fetch(`${Config.API_BASE}/auth/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ phone, password })
                });
                
                const data = await response.json();
                
                if (data.success && data.data.token) {
                    State.token = data.data.token;
                    State.currentUser = data.data.user;
                    
                    localStorage.setItem(Config.TOKEN_KEY, State.token);
                    localStorage.setItem(Config.USER_KEY, JSON.stringify(data.data.user));
                    
                    showToast("Login successful!", "success");
                    showApp();
                    loadDashboard();
                } else {
                    throw new Error(data.message || "Login failed");
                }
            } catch (error) {
                errorDisplay.textContent = error.message;
                errorDisplay.style.display = "block";
                showToast(error.message, "error");
            } finally {
                loginBtn.textContent = originalText;
                loginBtn.disabled = false;
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                State.token = null;
                State.currentUser = null;
                localStorage.removeItem(Config.TOKEN_KEY);
                localStorage.removeItem(Config.USER_KEY);
                showLogin();
            }
        }

        // ========== API SERVICE ==========
        async function apiRequest(endpoint, options = {}) {
            if (!State.token) {
                showLogin();
                throw new Error('Not authenticated');
            }
            
            const url = `${Config.API_BASE}${endpoint}`;
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${State.token}`,
                ...options.headers
            };
            
            try {
                const response = await fetch(url, { ...options, headers });
                
                if (response.status === 401) {
                    showToast('Session expired. Please login again.', 'error');
                    logout();
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                showToast(`API Error: ${error.message}`, 'error');
                throw error;
            }
        }

        // ========== UI UTILITIES ==========
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            toast.innerHTML = `
                <div class="toast-content">
                    <span class="toast-icon">${icons[type] || icons.info}</span>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        function formatCurrency(amount) {
            return `‡ß≥ ${parseFloat(amount || 0).toFixed(2)}`;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatTimeAgo(dateString) {
            if (!dateString) return 'Never';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${Math.floor(diffHours / 24)}d ago`;
        }

        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }

        function setLoading(loading) {
            State.isLoading = loading;
            document.body.style.cursor = loading ? 'wait' : 'default';
        }

        // ========== CHART FUNCTIONS ==========
        function initRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (State.charts.revenue) {
                State.charts.revenue.destroy();
            }
            
            State.charts.revenue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Revenue',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Revenue: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: {
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        }
                    }
                }
            });
        }

        function initRequestsChart() {
            const ctx = document.getElementById('requestsChart').getContext('2d');
            
            if (State.charts.requests) {
                State.charts.requests.destroy();
            }
            
            State.charts.requests = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#10b981', // Completed
                            '#f59e0b', // Searching/Accepted
                            '#ef4444', // Cancelled
                            '#3b82f6', // Other
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { display: true, position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} requests (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateRevenueChart(revenueData) {
            if (!State.charts.revenue) initRevenueChart();
            
            if (!revenueData || revenueData.length === 0) {
                document.getElementById('revenueChart').parentElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <div class="empty-title">No revenue data</div>
                        <div class="empty-description">No completed deliveries in selected period</div>
                    </div>
                `;
                return;
            }
            
            const labels = revenueData.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            const data = revenueData.map(item => item.revenue);
            
            State.charts.revenue.data.labels = labels;
            State.charts.revenue.data.datasets[0].data = data;
            State.charts.revenue.update();
        }

        function updateRequestsChart(statusBreakdown) {
            if (!State.charts.requests) initRequestsChart();
            
            if (!statusBreakdown || Object.keys(statusBreakdown).length === 0) {
                document.getElementById('requestsChart').parentElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì¶</div>
                        <div class="empty-title">No requests data</div>
                        <div class="empty-description">No delivery requests yet</div>
                    </div>
                `;
                return;
            }
            
            const labels = Object.keys(statusBreakdown).map(key => {
                return key.charAt(0).toUpperCase() + key.slice(1);
            });
            
            const data = Object.values(statusBreakdown);
            
            State.charts.requests.data.labels = labels;
            State.charts.requests.data.datasets[0].data = data;
            State.charts.requests.update();
        }

        // ========== MAP FUNCTIONS WITH CUSTOM MARKER ==========
        function initMap() {
            const mapContainer = document.getElementById('mapContainer');
            if (!mapContainer) return;
            
            // Default to Dhaka coordinates
            const defaultLocation = { lat: 23.8103, lng: 90.4125 };
            
            try {
                State.map = new google.maps.Map(mapContainer, {
                    zoom: 12,
                    center: defaultLocation,
                    mapTypeId: 'roadmap',
                    styles: [
                        {
                            featureType: "poi",
                            elementType: "labels",
                            stylers: [{ visibility: "off" }]
                        }
                    ]
                });
            } catch (error) {
                console.error('Google Maps initialization error:', error);
                mapContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <div class="empty-title">Map Failed to Load</div>
                        <div class="empty-description">Google Maps API error: ${error.message}</div>
                    </div>
                `;
            }
        }

        function updateMapWithPartners(partners) {
            if (!State.map || !partners || partners.length === 0) {
                document.getElementById('mapContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìç</div>
                        <div class="empty-title">No partners with GPS</div>
                        <div class="empty-description">No online partners have shared their location</div>
                    </div>
                `;
                return;
            }
            
            // Clear existing markers
            State.mapMarkers.forEach(marker => marker.setMap(null));
            State.mapMarkers = [];
            
            // Create custom marker icon
            const customIcon = {
                url: Config.CUSTOM_MARKER_URL,
                scaledSize: new google.maps.Size(40, 40),
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(20, 40)
            };
            
            // Add markers for each partner with custom FOOTMAN icon
            partners.forEach(partner => {
                if (partner.latitude && partner.longitude) {
                    const marker = new google.maps.Marker({
                        position: { lat: parseFloat(partner.latitude), lng: parseFloat(partner.longitude) },
                        map: State.map,
                        title: partner.full_name,
                        icon: customIcon,
                        animation: google.maps.Animation.DROP
                    });
                    
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 10px; min-width: 200px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <img src="${partner.profile_image_url || Config.CUSTOM_MARKER_URL}" 
                                         style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;"
                                         onerror="this.src='${Config.CUSTOM_MARKER_URL}'">
                                    <div>
                                        <strong style="font-size: 16px;">${partner.full_name}</strong><br>
                                        <span style="color: #10b981;">üü¢ Online</span>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <div><small>üì± ${partner.phone}</small></div>
                                    <div><small>‚≠ê ${partner.rating || 0}/5</small></div>
                                    <div><small>üì¶ Jobs: ${partner.total_completed_jobs || 0}</small></div>
                                    <div><small>üîÑ Active: ${partner.active_jobs || 0}</small></div>
                                </div>
                                <div style="margin-top: 8px;">
                                    <small>üìç Last update: ${formatTimeAgo(partner.last_location_update)}</small>
                                </div>
                                <div style="margin-top: 10px; display: flex; gap: 8px;">
                                    <button onclick="viewPartnerDetails(${partner.id})" 
                                            style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                        üëÅÔ∏è View Details
                                    </button>
                                    <button onclick="State.map.panTo({lat: ${partner.latitude}, lng: ${partner.longitude}}); State.map.setZoom(15);" 
                                            style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                        üéØ Center
                                    </button>
                                </div>
                            </div>
                        `
                    });
                    
                    marker.addListener('click', () => {
                        infoWindow.open(State.map, marker);
                    });
                    
                    State.mapMarkers.push(marker);
                }
            });
            
            // Fit map to show all markers
            if (State.mapMarkers.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                State.mapMarkers.forEach(marker => bounds.extend(marker.getPosition()));
                State.map.fitBounds(bounds);
            }
        }

        // ========== NAVIGATION ==========
        function setupNavigation() {
            document.getElementById('menuToggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('show');
            });
            
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    const page = btn.dataset.page;
                    switchPage(page);
                    if (window.innerWidth <= 1200) {
                        document.getElementById('sidebar').classList.remove('show');
                    }
                });
            });
            
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            document.getElementById('loginBtn').addEventListener('click', () => {
                const phone = document.getElementById('loginPhone').value;
                const password = document.getElementById('loginPassword').value;
                if (!phone || !password) {
                    document.getElementById('loginError').textContent = 'Please enter phone and password';
                    document.getElementById('loginError').style.display = 'block';
                    return;
                }
                login(phone, password);
            });
            
            document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('loginBtn').click();
                }
            });
            
            // Event listeners
            document.getElementById('revenuePeriod').addEventListener('change', (e) => {
                loadRevenueTimeSeries(e.target.value);
            });
            
            document.getElementById('refreshActivity').addEventListener('click', () => loadDashboard());
            document.getElementById('refreshOnline').addEventListener('click', () => loadOnlinePartners());
            document.getElementById('refreshPending').addEventListener('click', () => loadPendingApprovals());
            document.getElementById('refreshRejected').addEventListener('click', () => loadRejectedPartners());
            document.getElementById('exportEarnings').addEventListener('click', () => {
                showToast('Export feature requires backend implementation', 'info');
            });
            
            // Modal close buttons
            document.getElementById('closeModal').addEventListener('click', () => {
                document.getElementById('userModal').classList.remove('show');
            });
            
            document.getElementById('closeDocumentsModal').addEventListener('click', () => {
                document.getElementById('documentsModal').classList.remove('show');
            });
            
            document.getElementById('closeRequestModal').addEventListener('click', () => {
                document.getElementById('requestModal').classList.remove('show');
            });
            
            // Reject modal buttons
            document.getElementById('closeRejectModal').addEventListener('click', () => {
                document.getElementById('rejectReasonModal').classList.remove('show');
                State.pendingRejectId = null;
                document.getElementById('rejectReasonInput').value = '';
            });
            
            document.getElementById('cancelRejectBtn').addEventListener('click', () => {
                document.getElementById('rejectReasonModal').classList.remove('show');
                State.pendingRejectId = null;
                document.getElementById('rejectReasonInput').value = '';
            });
            
            document.getElementById('confirmRejectBtn').addEventListener('click', async () => {
                const reason = document.getElementById('rejectReasonInput').value.trim();
                if (!reason) {
                    showToast('Please enter rejection reason', 'warning');
                    return;
                }
                if (State.pendingRejectId) {
                    await rejectPartnerWithReason(State.pendingRejectId, reason);
                    document.getElementById('rejectReasonModal').classList.remove('show');
                    State.pendingRejectId = null;
                    document.getElementById('rejectReasonInput').value = '';
                }
            });
            
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('show');
                        if (modal.id === 'rejectReasonModal') {
                            State.pendingRejectId = null;
                            document.getElementById('rejectReasonInput').value = '';
                        }
                    }
                });
            });
            
            // Update time
            function updateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
                document.getElementById('currentTime').textContent = timeString;
            }
            updateTime();
            setInterval(updateTime, 60000);
        }

        function switchPage(page) {
            State.currentPage = page;
            
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.page === page);
            });
            
            const titles = {
                dashboard: 'Dashboard',
                users: 'User Management',
                partners: 'Delivery Partners',
                customers: 'Customers',
                requests: 'Delivery Requests',
                earnings: 'Earnings & Reports',
                online: 'Online Partners',
                pending: 'Pending Approvals',
                rejected: 'Rejected Partners',
                documents: 'Document Verification'
            };
            
            document.getElementById('pageTitle').textContent = titles[page] || 'Dashboard';
            
            document.querySelectorAll('.page-content').forEach(content => {
                content.classList.toggle('d-none', content.id !== `${page}Page`);
            });
            
            loadPageData(page);
        }

        // ========== PAGINATION FUNCTIONS ==========
        function renderPagination(containerId, currentPage, totalPages, onPageChange) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            // Previous button
            if (currentPage > 1) {
                html += `<button class="page-btn" onclick="${onPageChange}(${currentPage - 1})">‚Äπ Prev</button>`;
            }
            
            // First page
            if (startPage > 1) {
                html += `<button class="page-btn" onclick="${onPageChange}(1)">1</button>`;
                if (startPage > 2) html += `<span class="text-muted">...</span>`;
            }
            
            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="${onPageChange}(${i})">${i}</button>`;
            }
            
            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) html += `<span class="text-muted">...</span>`;
                html += `<button class="page-btn" onclick="${onPageChange}(${totalPages})">${totalPages}</button>`;
            }
            
            // Next button
            if (currentPage < totalPages) {
                html += `<button class="page-btn" onclick="${onPageChange}(${currentPage + 1})">Next ‚Ä∫</button>`;
            }
            
            container.innerHTML = html;
        }

        // ========== DASHBOARD FUNCTIONS ==========
        async function loadDashboard() {
            try {
                const dashboardData = await apiRequest('/admin/dashboard');
                if (dashboardData?.success) {
                    updateDashboardStats(dashboardData.data.stats);
                    updateRequestsChart(dashboardData.data.stats.status_breakdown);
                }
                
                await loadRevenueTimeSeries('7days');
                await loadRecentRequests();
                
            } catch (error) {
                console.error('Dashboard load error:', error);
                showToast('Failed to load dashboard data', 'error');
            }
        }

        async function loadRevenueTimeSeries(period = '7days') {
            try {
                const revenueData = await apiRequest(`/admin/revenue-timeseries?period=${period}`);
                if (revenueData?.success) {
                    updateRevenueChart(revenueData.data.revenue_data);
                } else {
                    document.getElementById('revenueChart').parentElement.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìä</div>
                            <div class="empty-title">No revenue data available</div>
                            <div class="empty-description">Revenue time series endpoint returned no data</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Revenue time series load error:', error);
                document.getElementById('revenueChart').parentElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <div class="empty-title">Failed to load revenue data</div>
                        <div class="empty-description">${error.message}</div>
                    </div>
                `;
            }
        }

        async function loadRecentRequests() {
            try {
                const requests = await apiRequest('/admin/requests?limit=10&page=1');
                if (!requests?.success) {
                    throw new Error('Failed to load recent requests');
                }
                
                const activityTable = document.getElementById('activityTable');
                const recentRequests = requests.data.requests.slice(0, 10);
                
                if (recentRequests.length === 0) {
                    activityTable.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-icon">üì≠</div>
                                <div class="empty-title">No recent requests</div>
                                <div class="empty-description">No delivery requests have been made yet.</div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                activityTable.innerHTML = recentRequests.map(req => {
                    const statusBadges = {
                        completed: '<span class="status-badge status-completed">‚úÖ Completed</span>',
                        cancelled: '<span class="status-badge status-inactive">‚ùå Cancelled</span>',
                        searching: '<span class="status-badge status-pending">üîç Searching</span>',
                        accepted: '<span class="status-badge status-active">‚úÖ Accepted</span>',
                        accepted_by_partner: '<span class="status-badge status-active">‚úÖ Accepted by Partner</span>',
                        ongoing: '<span class="status-badge status-ongoing">üîÑ Ongoing</span>'
                    };
                    
                    return `
                        <tr>
                            <td>${req.request_number}</td>
                            <td>
                                <div class="user-cell">
                                    <div class="avatar">
                                        ${req.customer?.profile_image_url ? 
                                            `<img src="${req.customer.profile_image_url}" alt="${req.customer.full_name}">` : 
                                            getInitials(req.customer?.full_name)}
                                    </div>
                                    <div class="user-info">
                                        <div class="user-name">${req.customer?.full_name || 'Customer'}</div>
                                        <div class="user-email">${req.customer?.phone || ''}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                ${req.footman ? `
                                    <div class="user-cell">
                                        <div class="avatar">
                                            ${req.footman.profile_image_url ? 
                                                `<img src="${req.footman.profile_image_url}" alt="${req.footman.full_name}">` : 
                                                getInitials(req.footman.full_name)}
                                        </div>
                                        <div class="user-info">
                                            <div class="user-name">${req.footman.full_name}</div>
                                            <div class="user-email">${req.footman.phone}</div>
                                        </div>
                                    </div>
                                ` : '-'}
                            </td>
                            <td>${statusBadges[req.request_status] || '<span class="status-badge">‚ùì Unknown</span>'}</td>
                            <td><strong>${formatCurrency(req.base_price)}</strong></td>
                            <td>${formatCurrency(req.commission)}</td>
                            <td>${formatTimeAgo(req.created_at)}</td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Recent requests load error:', error);
                document.getElementById('activityTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-icon">‚ö†Ô∏è</div>
                            <div class="empty-title">Failed to load recent requests</div>
                            <div class="empty-description">${error.message}</div>
                        </td>
                    </tr>
                `;
            }
        }

        function updateDashboardStats(stats) {
            // Update stats cards
            document.getElementById('totalRevenue').textContent = formatCurrency(stats.total_revenue || 0);
            document.getElementById('totalCommission').textContent = formatCurrency(stats.total_commission || 0);
            document.getElementById('totalRequests').textContent = stats.total_requests || 0;
            document.getElementById('todayRequests').textContent = stats.today_requests || 0;
            document.getElementById('totalUsers').textContent = (stats.total_customers || 0) + (stats.total_delivery_boys || 0);
            document.getElementById('totalPartners').textContent = stats.total_delivery_boys || 0;
            document.getElementById('totalCustomers').textContent = stats.total_customers || 0;
            document.getElementById('onlinePartners').textContent = stats.online_partners || 0;
            document.getElementById('activePartners').textContent = stats.total_delivery_boys || 0;
            
            // Update badges with correct counts
            document.getElementById('requestsBadge').textContent = stats.total_requests || 0;
            document.getElementById('usersBadge').textContent = (stats.total_customers || 0) + (stats.total_delivery_boys || 0);
            document.getElementById('partnersBadge').textContent = stats.total_delivery_boys || 0;
            document.getElementById('customersBadge').textContent = stats.total_customers || 0;
            document.getElementById('onlineBadge').textContent = stats.online_partners || 0;
            document.getElementById('pendingBadge').textContent = stats.pending_approvals || 0;
            document.getElementById('rejectedBadge').textContent = stats.rejected_partners || 0;
            
            // Revenue change indicator
            const revenueChange = document.getElementById('revenueChange');
            if (stats.total_revenue > 0) {
                revenueChange.innerHTML = `<span>‚Üó</span> ${formatCurrency(stats.total_revenue)} total`;
            } else {
                revenueChange.innerHTML = `<span>‚Üí</span> No revenue yet`;
            }
        }

        // ========== USERS MANAGEMENT ==========
        async function loadUsers() {
            try {
                const params = new URLSearchParams(State.filters.users);
                const result = await apiRequest(`/admin/users?${params}`);
                if (result?.success) {
                    renderUsersTable(result.data.users);
                    renderPagination('usersPagination', 
                        State.filters.users.page, 
                        result.data.pagination.pages,
                        'goToUsersPage'
                    );
                }
            } catch (error) {
                console.error('Users load error:', error);
                document.getElementById('usersTable').innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div class="empty-icon">‚ö†Ô∏è</div>
                            <div class="empty-title">Failed to load users</div>
                            <div class="empty-description">${error.message}</div>
                        </td>
                    </tr>
                `;
            }
        }

        function searchUsers() {
            const search = document.getElementById('userSearch').value;
            State.filters.users.search = search;
            State.filters.users.page = 1;
            loadUsers();
        }

        function filterUsers() {
            const type = document.getElementById('userTypeFilter').value;
            const status = document.getElementById('userStatusFilter').value;
            const online = document.getElementById('userOnlineFilter').value;
            
            State.filters.users.user_type = type;
            State.filters.users.status = status;
            State.filters.users.is_online = online;
            State.filters.users.page = 1;
            
            loadUsers();
        }

        function goToUsersPage(page) {
            State.filters.users.page = page;
            loadUsers();
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTable');
            
            if (!users || users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div class="empty-icon">üë•</div>
                            <div class="empty-title">No users found</div>
                            <div class="empty-description">No users match your filters.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = users.map(user => {
                const userType = user.user_type || 'customer';
                const isActive = user.is_active !== false;
                const isOnline = user.is_online === true;
                const isRejected = user.rejection_reason !== null;
                
                const typeBadges = {
                    admin: '<span class="status-badge status-active">üëë Admin</span>',
                    delivery: '<span class="status-badge status-active">üöö Partner</span>',
                    customer: '<span class="status-badge status-active">üë§ Customer</span>'
                };
                
                let statusBadge = '';
                if (userType === 'delivery') {
                    if (isActive) {
                        statusBadge = '<span class="status-badge status-active">‚úÖ Active</span>';
                    } else if (isRejected) {
                        statusBadge = '<span class="status-badge status-rejected">‚ùå Rejected</span>';
                    } else {
                        statusBadge = '<span class="status-badge status-pending">‚è≥ Pending</span>';
                    }
                } else {
                    statusBadge = isActive ? 
                        '<span class="status-badge status-active">‚úÖ Active</span>' : 
                        '<span class="status-badge status-inactive">‚ö´ Inactive</span>';
                }
                
                const onlineBadge = isOnline ?
                    '<span class="status-badge status-online">üü¢ Online</span>' :
                    '<span class="status-badge status-offline">‚ö´ Offline</span>';
                
                return `
                    <tr>
                        <td>${user.id}</td>
                        <td>
                            <div class="user-cell">
                                <div class="avatar">
                                    ${user.profile_image_url && user.profile_image_url !== 'null' ? 
                                        `<img src="${user.profile_image_url}" alt="${user.full_name}">` : 
                                        getInitials(user.full_name)}
                                </div>
                                <div class="user-info">
                                    <div class="user-name">${user.full_name || 'N/A'}</div>
                                    <div class="user-email">${user.email || 'No email'}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>${user.phone || 'N/A'}</div>
                            ${user.emergency_contact_phone ? `<small class="text-muted">Emergency: ${user.emergency_contact_phone}</small>` : ''}
                        </td>
                        <td>${typeBadges[userType] || typeBadges.customer}</td>
                        <td>${statusBadge}</td>
                        <td>${onlineBadge}</td>
                        <td>${formatDate(user.created_at)}</td>
                        <td>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary btn-sm" onclick="viewUserDetails(${user.id})">
                                    üëÅÔ∏è View
                                </button>
                                ${userType === 'delivery' && !isActive && !isRejected ? 
                                    `<button class="btn btn-success btn-sm" onclick="approvePartner(${user.id})">
                                        ‚úì Approve
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="openRejectModal(${user.id})">
                                        ‚úó Reject
                                    </button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== DELIVERY PARTNERS ==========
        async function loadPartners() {
            try {
                const params = new URLSearchParams(State.filters.partners);
                params.set('user_type', 'delivery');
                const result = await apiRequest(`/admin/users?${params}`);
                if (result?.success) {
                    renderPartnersTable(result.data.users);
                    renderPagination('partnersPagination', 
                        State.filters.partners.page, 
                        result.data.pagination.pages,
                        'goToPartnersPage'
                    );
                    renderDocumentsTable(result.data.users.filter(p => !p.is_active && !p.rejection_reason));
                }
            } catch (error) {
                console.error('Partners load error:', error);
                document.getElementById('partnersTable').innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <div class="empty-icon">‚ö†Ô∏è</div>
                            <div class="empty-title">Failed to load partners</div>
                            <div class="empty-description">${error.message}</div>
                        </td>
                    </tr>
                `;
            }
        }

        function searchPartners() {
            const search = document.getElementById('partnerSearch').value;
            State.filters.partners.search = search;
            State.filters.partners.page = 1;
            loadPartners();
        }

        function filterPartners() {
            const status = document.getElementById('partnerStatusFilter').value;
            const online = document.getElementById('partnerOnlineFilter').value;
            
            State.filters.partners.status = status;
            State.filters.partners.is_online = online;
            State.filters.partners.page = 1;
            
            loadPartners();
        }

        function goToPartnersPage(page) {
            State.filters.partners.page = page;
            loadPartners();
        }

        function renderPartnersTable(partners) {
            const tbody = document.getElementById('partnersTable');
            
            if (!partners || partners.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <div class="empty-icon">üöö</div>
                            <div class="empty-title">No delivery partners</div>
                            <div class="empty-description">No delivery partners match your filters.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = partners.map(partner => {
                const isActive = partner.is_active !== false;
                const isOnline = partner.is_online === true;
                const hasLocation = partner.latitude && partner.longitude;
                const isRejected = partner.rejection_reason !== null;
                
                let statusBadge = '';
                if (isActive) {
                    statusBadge = '<span class="status-badge status-active">‚úÖ Active</span>';
                } else if (isRejected) {
                    statusBadge = '<span class="status-badge status-rejected">‚ùå Rejected</span>';
                } else {
                    statusBadge = '<span class="status-badge status-pending">‚è≥ Pending</span>';
                }
                
                const onlineBadge = isOnline ?
                    '<span class="status-badge status-online">üü¢ Online</span>' :
                    '<span class="status-badge status-offline">‚ö´ Offline</span>';
                
                const locationInfo = hasLocation ? 
                    `<small class="text-success">üìç ${parseFloat(partner.latitude).toFixed(4)}, ${parseFloat(partner.longitude).toFixed(4)}</small>` :
                    '<small class="text-muted">üìç No GPS</small>';
                
                return `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="avatar">
                                    ${partner.profile_image_url && partner.profile_image_url !== 'null' ? 
                                        `<img src="${partner.profile_image_url}" alt="${partner.full_name}">` : 
                                        getInitials(partner.full_name)}
                                </div>
                                <div class="user-info">
                                    <div class="user-name">${partner.full_name || 'N/A'}</div>
                                    <div class="user-email">${partner.nid_number || 'No NID'}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>${partner.phone || 'N/A'}</div>
                            ${partner.emergency_contact_phone ? `<small class="text-muted">Emergency: ${partner.emergency_contact_phone}</small>` : ''}
                        </td>
                        <td>${partner.nid_number || 'N/A'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            ${partner.rejection_reason ? 
                                `<span class="text-danger" title="${partner.rejection_reason}">${partner.rejection_reason.substring(0, 30)}${partner.rejection_reason.length > 30 ? '...' : ''}</span>` : 
                                '-'}
                        </td>
                        <td>${onlineBadge}</td>
                        <td>${locationInfo}</td>
                        <td>${partner.rating || 'N/A'}/5</td>
                        <td>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary btn-sm" onclick="viewPartnerDetails(${partner.id})">
                                    üëÅÔ∏è View
                                </button>
                                <button class="btn btn-info btn-sm" onclick="viewPartnerDocuments(${partner.id})">
                                    üìÑ Review All
                                </button>
                                ${!isActive && !isRejected ? 
                                    `<button class="btn btn-success btn-sm" onclick="approvePartner(${partner.id})">
                                        ‚úì Approve
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="openRejectModal(${partner.id})">
                                        ‚úó Reject
                                    </button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderDocumentsTable(pendingPartners) {
            const tbody = document.getElementById('documentsTable');
            
            if (!pendingPartners || pendingPartners.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div class="empty-icon">‚úÖ</div>
                            <div class="empty-title">All documents verified</div>
                            <div class="empty-description">No pending document verifications.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = pendingPartners.map(partner => {
                const hasProfile = partner.profile_image_url && partner.profile_image_url !== 'null';
                const hasNidFront = partner.nid_front_image_url && partner.nid_front_image_url !== 'null';
                const hasNidBack = partner.nid_back_image_url && partner.nid_back_image_url !== 'null';
                
                const docsStatus = `
                    <div class="d-flex gap-2">
                        ${hasProfile ? 
                            '<span class="status-badge status-active">‚úÖ Photo</span>' : 
                            '<span class="status-badge status-pending">‚ùå Photo</span>'}
                        ${hasNidFront ? 
                            '<span class="status-badge status-active">‚úÖ NID F</span>' : 
                            '<span class="status-badge status-pending">‚ùå NID F</span>'}
                        ${hasNidBack ? 
                            '<span class="status-badge status-active">‚úÖ NID B</span>' : 
                            '<span class="status-badge status-pending">‚ùå NID B</span>'}
                    </div>
                `;
                
                const nidVerified = hasNidFront && hasNidBack && partner.nid_number;
                
                return `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="avatar">
                                    ${partner.profile_image_url && partner.profile_image_url !== 'null' ? 
                                        `<img src="${partner.profile_image_url}" alt="${partner.full_name}">` : 
                                        getInitials(partner.full_name)}
                                </div>
                                <div class="user-info">
                                    <div class="user-name">${partner.full_name || 'N/A'}</div>
                                    <div class="user-email">${partner.phone || 'N/A'}</div>
                                </div>
                            </div>
                        </td>
                        <td>${docsStatus}</td>
                        <td>
                            ${nidVerified ? 
                                '<span class="status-badge status-active">‚úÖ Verified</span>' : 
                                '<span class="status-badge status-pending">‚ùå Not Verified</span>'}
                        </td>
                        <td>${formatDate(partner.created_at)}</td>
                        <td>
                            <div class="d-flex gap-2">
                                <button class="btn btn-success btn-sm" onclick="approvePartner(${partner.id})">
                                    ‚úì Approve
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="openRejectModal(${partner.id})">
                                    ‚úó Reject
                                </button>
                                <button class="btn btn-info btn-sm" onclick="viewPartnerDocuments(${partner.id})">
                                    üìÑ Review All
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== CUSTOMERS WITH PHOTOS ==========
        async function loadCustomers() {
            try {
                const params = new URLSearchParams(State.filters.customers);
                params.set('user_type', 'customer');
                const result = await apiRequest(`/admin/users?${params}`);
                if (result?.success) {
                    renderCustomersTable(result.data.users);
                    renderPagination('customersPagination', 
                        State.filters.customers.page, 
                        result.data.pagination.pages,
                        'goToCustomersPage'
                    );
                }
            } catch (error) {
                console.error('Customers load error:', error);
                document.getElementById('customersTable').innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div class="empty-icon">‚ö†Ô∏è</div>
                            <div class="empty-title">Failed to load customers</div>
                            <div class="empty-description">${error.message}</div>
                        </td>
                    </tr>
                `;
            }
        }

        function searchCustomers() {
            const search = document.getElementById('customerSearch').value;
            State.filters.customers.search = search;
            State.filters.customers.page = 1;
            loadCustomers();
        }

        function filterCustomers() {
            const status = document.getElementById('customerStatusFilter').value;
            State.filters.customers.status = status;
            State.filters.customers.page = 1;
            loadCustomers();
        }

        function goToCustomersPage(page) {
            State.filters.customers.page = page;
            loadCustomers();
        }

        function renderCustomersTable(customers) {
            const tbody = document.getElementById('customersTable');
            
            if (!customers || customers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div class="empty-icon">üë§</div>
                            <div class="empty-title">No customers</div>
                            <div class="empty-description">No customers match your filters.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = customers.map(customer => {
                const isActive = customer.is_active !== false;
                
                const statusBadge = isActive ? 
                    '<span class="status-badge status-active">‚úÖ Active</span>' : 
                    '<span class="status-badge status-inactive">‚ö´ Inactive</span>';
                
                return `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="avatar">
                                    ${customer.profile_image_url && customer.profile_image_url !== 'null' ? 
                                        `<img src="${customer.profile_image_url}" alt="${customer.full_name}">` : 
                                        getInitials(customer.full_name)}
                                </div>
                                <div class="user-info">
                                    <div class="user-name">${customer.full_name || 'N/A'}</div>
                                    <div class="user-email">${customer.email || 'No email'}</div>
                                </div>
                            </div>
                        </td>
                        <td>${customer.phone || 'N/A'}</td>
                        <td>
                            ${customer.profile_image_url && customer.profile_image_url !== 'null' ? 
                                `<img src="${customer.profile_image_url}" alt="Profile" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : 
                                '<span class="text-muted">No photo</span>'}
                        </td>
                        <td>0</td>
                        <td>${formatCurrency(0)}</td>
                        <td>Never</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="viewUserDetails(${customer.id})">
                                üëÅÔ∏è View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== DELIVERY REQUESTS ==========
        async function loadRequests() {
            try {
                const params = new URLSearchParams(State.filters.requests);
                const result = await apiRequest(`/admin/requests?${params}`);
                if (result?.success) {
                    renderRequestsTable(result.data.requests);
                    document.getElementById('requestsBadge').textContent = result.data.totals.total_requests || 0;
                    renderPagination('requestsPagination', 
                        State.filters.requests.page, 
                        result.data.pagination.pages,
                        'goToRequestsPage'
                    );
                }
            } catch (error) {
                console.error('Requests load error:', error);
                document.getElementById('requestsTable').innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <div class="empty-icon">‚ö†Ô∏è</div>
                            <div class="empty-title">Failed to load requests</div>
                            <div class="empty-description">${error.message}</div>
                        </td>
                    </tr>
                `;
            }
        }

        function searchRequests() {
            const search = document.getElementById('requestSearch').value;
            State.filters.requests.search = search;
            State.filters.requests.page = 1;
            loadRequests();
        }

        function filterRequests() {
            const status = document.getElementById('requestStatusFilter').value;
            const dateRange = document.getElementById('requestDateFilter').value;
            
            State.filters.requests.status = status;
            State.filters.requests.date_range = dateRange;
            State.filters.requests.page = 1;
            
            loadRequests();
        }

        function goToRequestsPage(page) {
            State.filters.requests.page = page;
            loadRequests();
        }

        function renderRequestsTable(requests) {
            const tbody = document.getElementById('requestsTable');
            
            if (!requests || requests.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <div class="empty-icon">üì≠</div>
                            <div class="empty-title">No delivery requests</div>
                            <div class="empty-description">No delivery requests match your filters.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = requests.map(req => {
                const statusBadges = {
                    completed: '<span class="status-badge status-completed">‚úÖ Completed</span>',
                    cancelled: '<span class="status-badge status-inactive">‚ùå Cancelled</span>',
                    searching: '<span class="status-badge status-pending">üîç Searching</span>',
                    accepted: '<span class="status-badge status-active">‚úÖ Accepted</span>',
                    accepted_by_partner: '<span class="status-badge status-active">‚úÖ Accepted by Partner</span>',
                    ongoing: '<span class="status-badge status-ongoing">üîÑ Ongoing</span>'
                };
                
                const methodBadges = {
                    cash: '<span class="status-badge">üí∞ Cash</span>',
                    bkash: '<span class="status-badge" style="background:#E2136E;color:white;">bKash</span>',
                    nagad: '<span class="status-badge" style="background:#E30A17;color:white;">Nagad</span>'
                };
                
                return `
                    <tr>
                        <td>${req.request_number}</td>
                        <td>
                            <div class="user-cell">
                                <div class="avatar">
                                    ${req.customer?.profile_image_url ? 
                                        `<img src="${req.customer.profile_image_url}" alt="${req.customer.full_name}">` : 
                                        getInitials(req.customer?.full_name)}
                                </div>
                                <div class="user-info">
                                    <div class="user-name">${req.customer?.full_name || 'Customer'}</div>
                                    <div class="user-email">${req.customer?.phone || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            ${req.footman ? `
                                <div class="user-cell">
                                    <div class="avatar">
                                        ${req.footman.profile_image_url ? 
                                            `<img src="${req.footman.profile_image_url}" alt="${req.footman.full_name}">` : 
                                            getInitials(req.footman.full_name)}
                                    </div>
                                    <div class="user-info">
                                        <div class="user-name">${req.footman.full_name}</div>
                                        <div class="user-email">${req.footman.phone}</div>
                                    </div>
                                </div>
                            ` : '-'}
                        </td>
                        <td>${statusBadges[req.request_status] || '<span class="status-badge">‚ùì Unknown</span>'}</td>
                        <td><strong>${formatCurrency(req.base_price)}</strong></td>
                        <td>${formatCurrency(req.commission)}</td>
                        <td>${methodBadges[req.customer_selected_payment] || '<span class="status-badge">‚ùì Unknown</span>'}</td>
                        <td>${formatDateTime(req.created_at)}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="viewRequestDetails(${req.id})">
                                üëÅÔ∏è View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== EARNINGS & REPORTS ==========
        async function loadEarnings() {
            try {
                const period = document.getElementById('earningsPeriod').value;
                const params = new URLSearchParams();
                if (period !== 'all') params.set('date_range', period);
                
                const result = await apiRequest(`/admin/requests?${params}`);
                if (!result?.success) {
                    throw new Error('Failed to load earnings data');
                }

                const allRequests = result.data.requests;
                const totals = result.data.totals;
                
                // Update earnings stats
                document.getElementById('earningsRevenue').textContent = formatCurrency(totals.total_revenue || 0);
                document.getElementById('earningsCommission').textContent = formatCurrency(totals.total_commission || 0);
                document.getElementById('earningsPartner').textContent = formatCurrency(totals.partner_earnings || 0);
                
                // Calculate success rate
                const totalRequests = totals.total_requests || 0;
                const completedRequests = allRequests.filter(req => req.request_status === 'completed').length;
                const successRate = totalRequests > 0 ? Math.round((completedRequests / totalRequests) * 100) : 0;
                document.getElementById('successRate').textContent = `${successRate}%`;
                
                // Payment method breakdown
                const paymentMethods = {};
                allRequests.forEach(req => {
                    if (req.request_status === 'completed' && req.customer_selected_payment) {
                        const method = req.customer_selected_payment;
                        if (!paymentMethods[method]) {
                            paymentMethods[method] = { count: 0, amount: 0, commission: 0 };
                        }
                        paymentMethods[method].count++;
                        paymentMethods[method].amount += parseFloat(req.base_price || 0);
                        paymentMethods[method].commission += parseFloat(req.commission || 0);
                    }
                });
                
                const paymentsTable = document.getElementById('paymentsTable');
                const paymentMethodsArray = Object.entries(paymentMethods);
                
                if (paymentMethodsArray.length === 0) {
                    paymentsTable.innerHTML = `
                        <tr>
                            <td colspan="5" class="empty-state">
                                <div class="empty-icon">üí∞</div>
                                <div class="empty-title">No payment data</div>
                                <div class="empty-description">No completed payments in selected period.</div>
                            </td>
                        </tr>
                    `;
                } else {
                    paymentsTable.innerHTML = paymentMethodsArray.map(([method, data]) => `
                        <tr>
                            <td><strong>${method.charAt(0).toUpperCase() + method.slice(1)}</strong></td>
                            <td>${data.count}</td>
                            <td><strong>${formatCurrency(data.amount)}</strong></td>
                            <td>${formatCurrency(data.commission)}</td>
                            <td>${totals.total_revenue > 0 ? ((data.amount / totals.total_revenue) * 100).toFixed(1) : 0}%</td>
                        </tr>
                    `).join('');
                }
                
                // Recent transactions
                const transactionsTable = document.getElementById('transactionsTable');
                const recentRequests = allRequests
                    .filter(req => req.request_status === 'completed')
                    .slice(0, 10);
                
                if (recentRequests.length === 0) {
                    transactionsTable.innerHTML = `
                        <tr>
                            <td colspan="8" class="empty-state">
                                <div class="empty-icon">üì≠</div>
                                <div class="empty-title">No transactions</div>
                                <div class="empty-description">No completed transactions in selected period.</div>
                            </td>
                        </tr>
                    `;
                } else {
                    transactionsTable.innerHTML = recentRequests.map(req => {
                        const methodBadges = {
                            cash: '<span class="status-badge">üí∞ Cash</span>',
                            bkash: '<span class="status-badge" style="background:#E2136E;color:white;">bKash</span>',
                            nagad: '<span class="status-badge" style="background:#E30A17;color:white;">Nagad</span>'
                        };
                        
                        return `
                            <tr>
                                <td>${formatDate(req.completed_at || req.created_at)}</td>
                                <td>${req.request_number}</td>
                                <td>
                                    <div class="user-cell">
                                        <div class="avatar">
                                            ${req.customer?.profile_image_url ? 
                                                `<img src="${req.customer.profile_image_url}" alt="${req.customer.full_name}">` : 
                                                getInitials(req.customer?.full_name)}
                                        </div>
                                        <div class="user-info">
                                            <div class="user-name">${req.customer?.full_name || 'Customer'}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>${req.footman?.full_name || '-'}</td>
                                <td><strong>${formatCurrency(req.base_price)}</strong></td>
                                <td>${formatCurrency(req.commission)}</td>
                                <td>${methodBadges[req.customer_selected_payment] || '<span class="status-badge">‚ùì Unknown</span>'}</td>
                                <td><span class="status-badge status-completed">‚úÖ Completed</span></td>
                            </tr>
                        `;
                    }).join('');
                }
                
            } catch (error) {
                console.error('Earnings load error:', error);
                showToast('Failed to load earnings data', 'error');
            }
        }

        // ========== ONLINE PARTNERS ==========
        async function loadOnlinePartners() {
            try {
                const params = new URLSearchParams(State.filters.online);
                const result = await apiRequest(`/admin/online-partners?${params}`);
                if (result?.success) {
                    renderOnlinePartnersTable(result.data.partners);
                    updateMapWithPartners(result.data.partners);
                    renderPagination('onlinePagination', 
                        State.filters.online.page, 
                        result.data.pagination.pages,
                        'goToOnlinePage'
                    );
                }
            } catch (error) {
                console.error('Online partners load error:', error);
                document.getElementById('onlineTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-icon">‚ö†Ô∏è</div>
                            <div class="empty-title">Failed to load online partners</div>
                            <div class="empty-description">${error.message}</div>
                        </td>
                    </tr>
                `;
            }
        }

        function goToOnlinePage(page) {
            State.filters.online.page = page;
            loadOnlinePartners();
        }

        function renderOnlinePartnersTable(partners) {
            const tbody = document.getElementById('onlineTable');
            
            if (!partners || partners.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-icon">üìç</div>
                            <div class="empty-title">No partners online</div>
                            <div class="empty-description">No delivery partners are currently online with GPS.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = partners.map(partner => {
                const hasLocation = partner.latitude && partner.longitude;
                
                const locationStatus = hasLocation ? 
                    `<span class="text-success">üìç ${parseFloat(partner.latitude).toFixed(4)}, ${parseFloat(partner.longitude).toFixed(4)}</span>` :
                    '<span class="text-muted">üìç No GPS</span>';
                
                return `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="avatar">
                                    ${partner.profile_image_url && partner.profile_image_url !== 'null' ? 
                                        `<img src="${partner.profile_image_url}" alt="${partner.full_name}">` : 
                                        getInitials(partner.full_name)}
                                </div>
                                <div class="user-info">
                                    <div class="user-name">${partner.full_name || 'N/A'}</div>
                                    <div class="user-email">${partner.phone || 'N/A'}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge status-online">üü¢ Online</span>
                        </td>
                        <td>
                            <span class="status-badge ${partner.active_jobs > 0 ? 'status-active' : 'status-pending'}">
                                ${partner.active_jobs > 0 ? 'üîÑ ' + partner.active_jobs + ' jobs' : '‚úÖ Available'}
                            </span>
                        </td>
                        <td>
                            <div>${locationStatus}</div>
                            <div><small class="text-muted">${partner.location_age ? partner.location_age + ' min ago' : 'Never updated'}</small></div>
                        </td>
                        <td>${formatTimeAgo(partner.last_location_update)}</td>
                        <td>${partner.rating || 'N/A'}/5</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="viewPartnerDetails(${partner.id})">
                                üëÅÔ∏è View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== PENDING APPROVALS ==========
        async function loadPendingApprovals() {
            try {
                const params = new URLSearchParams(State.filters.pending);
                const result = await apiRequest(`/admin/partners/pending?${params}`);
                if (result?.success) {
                    renderPendingApprovalsTable(result.data.partners);
                    renderPagination('pendingPagination', 
                        State.filters.pending.page, 
                        result.data.pagination.pages,
                        'goToPendingPage'
                    );
                }
            } catch (error) {
                console.error('Pending approvals load error:', error);
                document.getElementById('pendingTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-icon">‚ö†Ô∏è</div>
                            <div class="empty-title">Failed to load pending approvals</div>
                            <div class="empty-description">${error.message}</div>
                        </td>
                    </tr>
                `;
            }
        }

        function searchPending() {
            const search = document.getElementById('pendingSearch').value;
            State.filters.pending.search = search;
            State.filters.pending.page = 1;
            loadPendingApprovals();
        }

        function goToPendingPage(page) {
            State.filters.pending.page = page;
            loadPendingApprovals();
        }

        function renderPendingApprovalsTable(pending) {
            const tbody = document.getElementById('pendingTable');
            
            if (!pending || pending.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-icon">‚úÖ</div>
                            <div class="empty-title">All caught up!</div>
                            <div class="empty-description">No pending approvals at the moment.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = pending.map(partner => {
                const hasProfile = partner.profile_image_url && partner.profile_image_url !== 'null';
                const hasNidFront = partner.nid_front_image_url && partner.nid_front_image_url !== 'null';
                const hasNidBack = partner.nid_back_image_url && partner.nid_back_image_url !== 'null';
                const nidVerified = hasNidFront && hasNidBack && partner.nid_number;
                
                const docsStatus = `
                    <div class="d-flex gap-2">
                        ${hasProfile ? 
                            '<span class="status-badge status-active">‚úÖ Photo</span>' : 
                            '<span class="status-badge status-pending">‚ùå Photo</span>'}
                        ${hasNidFront ? 
                            '<span class="status-badge status-active">‚úÖ NID F</span>' : 
                            '<span class="status-badge status-pending">‚ùå NID F</span>'}
                        ${hasNidBack ? 
                            '<span class="status-badge status-active">‚úÖ NID B</span>' : 
                            '<span class="status-badge status-pending">‚ùå NID B</span>'}
                    </div>
                `;
                
                return `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="avatar">
                                    ${partner.profile_image_url && partner.profile_image_url !== 'null' ? 
                                        `<img src="${partner.profile_image_url}" alt="${partner.full_name}">` : 
                                        getInitials(partner.full_name)}
                                </div>
                                <div class="user-info">
                                    <div class="user-name">${partner.full_name || 'N/A'}</div>
                                    <div class="user-email">Applied: ${formatDate(partner.created_at)}</div>
                                </div>
                            </div>
                        </td>
                        <td>${formatDate(partner.created_at)}</td>
                        <td>${docsStatus}</td>
                        <td>
                            ${nidVerified ? 
                                '<span class="status-badge status-active">‚úÖ Verified</span>' : 
                                '<span class="status-badge status-pending">‚ùå Not Verified</span>'}
                        </td>
                        <td>
                            <div>${partner.phone || 'N/A'}</div>
                            ${partner.emergency_contact_phone ? `<small class="text-muted">Emergency: ${partner.emergency_contact_phone}</small>` : ''}
                        </td>
                        <td>
                            <div>${partner.emergency_contact_name || 'N/A'}</div>
                            <small class="text-muted">${partner.emergency_contact_relationship || 'N/A'}</small>
                        </td>
                        <td>
                            <div class="d-flex gap-2">
                                <button class="btn btn-success btn-sm" onclick="approvePartner(${partner.id})">
                                    ‚úì Approve
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="openRejectModal(${partner.id})">
                                    ‚úó Reject
                                </button>
                                <button class="btn btn-info btn-sm" onclick="viewPartnerDocuments(${partner.id})">
                                    üìÑ Review All
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== REJECTED PARTNERS (NEW) ==========
        async function loadRejectedPartners() {
            try {
                const params = new URLSearchParams(State.filters.rejected);
                const result = await apiRequest(`/admin/partners/rejected?${params}`);
                if (result?.success) {
                    renderRejectedPartnersTable(result.data.partners);
                    renderPagination('rejectedPagination', 
                        State.filters.rejected.page, 
                        result.data.pagination.pages,
                        'goToRejectedPage'
                    );
                }
            } catch (error) {
                console.error('Rejected partners load error:', error);
                document.getElementById('rejectedTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-icon">‚ö†Ô∏è</div>
                            <div class="empty-title">Failed to load rejected partners</div>
                            <div class="empty-description">${error.message}</div>
                        </td>
                    </tr>
                `;
            }
        }

        function searchRejected() {
            const search = document.getElementById('rejectedSearch').value;
            State.filters.rejected.search = search;
            State.filters.rejected.page = 1;
            loadRejectedPartners();
        }

        function goToRejectedPage(page) {
            State.filters.rejected.page = page;
            loadRejectedPartners();
        }

        function renderRejectedPartnersTable(partners) {
            const tbody = document.getElementById('rejectedTable');
            
            if (!partners || partners.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-icon">‚úÖ</div>
                            <div class="empty-title">No rejected partners</div>
                            <div class="empty-description">No partners have been rejected.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = partners.map(partner => {
                return `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="avatar">
                                    ${partner.profile_image_url && partner.profile_image_url !== 'null' ? 
                                        `<img src="${partner.profile_image_url}" alt="${partner.full_name}">` : 
                                        getInitials(partner.full_name)}
                                </div>
                                <div class="user-info">
                                    <div class="user-name">${partner.full_name || 'N/A'}</div>
                                    <div class="user-email">${partner.email || 'No email'}</div>
                                </div>
                            </div>
                        </td>
                        <td>${partner.phone || 'N/A'}</td>
                        <td>${partner.nid_number || 'N/A'}</td>
                        <td>
                            <span class="text-danger" style="display: block; max-width: 200px; white-space: normal;" title="${partner.rejection_reason}">
                                ‚ùå ${partner.rejection_reason || 'No reason provided'}
                            </span>
                        </td>
                        <td>Admin #${partner.rejected_by || 'N/A'}</td>
                        <td>${formatDateTime(partner.rejected_at)}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="viewPartnerDetails(${partner.id})">
                                üëÅÔ∏è View
                            </button>
                            <button class="btn btn-info btn-sm" onclick="viewPartnerDocuments(${partner.id})">
                                üìÑ Documents
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== DOCUMENT VERIFICATION ==========
        async function loadDocumentVerification() {
            try {
                const params = new URLSearchParams(State.filters.documents);
                const result = await apiRequest(`/admin/documents?${params}`);
                if (result?.success) {
                    renderDocumentsListView(result.data.documents);
                    renderPagination('documentsPagination', 
                        State.filters.documents.page, 
                        result.data.pagination.pages,
                        'goToDocumentsPage'
                    );
                }
            } catch (error) {
                console.error('Document verification load error:', error);
                document.getElementById('documentsListView').innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-icon">‚ö†Ô∏è</div>
                            <div class="empty-title">Failed to load documents</div>
                            <div class="empty-description">${error.message}</div>
                        </td>
                    </tr>
                `;
            }
        }

        function searchDocuments() {
            const search = document.getElementById('docSearch').value;
            State.filters.documents.search = search;
            State.filters.documents.page = 1;
            loadDocumentVerification();
        }

        function filterDocuments() {
            const status = document.getElementById('docStatusFilter').value;
            State.filters.documents.status = status;
            State.filters.documents.page = 1;
            loadDocumentVerification();
        }

        function goToDocumentsPage(page) {
            State.filters.documents.page = page;
            loadDocumentVerification();
        }

        function renderDocumentsListView(documents) {
            const tbody = document.getElementById('documentsListView');
            
            if (!documents || documents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-icon">üìÑ</div>
                            <div class="empty-title">No documents found</div>
                            <div class="empty-description">No documents match your filters.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = documents.map(doc => {
                const partner = doc.partner;
                
                let statusBadge = '';
                if (partner.status === 'verified') {
                    statusBadge = '<span class="status-badge status-active">‚úÖ Verified</span>';
                } else if (partner.status === 'rejected') {
                    statusBadge = '<span class="status-badge status-rejected">‚ùå Rejected</span>';
                } else {
                    statusBadge = '<span class="status-badge status-pending">‚è≥ Pending</span>';
                }
                
                return `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="avatar">
                                    ${partner.profile_image_url && partner.profile_image_url !== 'null' ? 
                                        `<img src="${partner.profile_image_url}" alt="${partner.name}">` : 
                                        getInitials(partner.name)}
                                </div>
                                <div class="user-info">
                                    <div class="user-name">${partner.name}</div>
                                    <div class="user-email">${partner.phone}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>${partner.phone}</div>
                            <small class="text-muted">Emergency: ${partner.emergency_contact_phone || 'Not provided'}</small>
                        </td>
                        <td>${partner.nid || 'Not provided'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            ${partner.rejection_reason ? 
                                `<span class="text-danger" title="${partner.rejection_reason}">${partner.rejection_reason.substring(0, 30)}${partner.rejection_reason.length > 30 ? '...' : ''}</span>` : 
                                '-'}
                        </td>
                        <td>${formatDate(partner.joined)}</td>
                        <td>
                            <div class="d-flex gap-2">
                                ${partner.status === 'pending' ? 
                                    `<button class="btn btn-success btn-sm" onclick="approvePartner(${partner.id})">
                                        ‚úì Approve
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="openRejectModal(${partner.id})">
                                        ‚úó Reject
                                    </button>` : ''}
                                <button class="btn btn-primary btn-sm" onclick="viewPartnerDocuments(${partner.id})">
                                    üìÑ Review All
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== PAGE DATA LOADING ==========
        async function loadPageData(page) {
            setLoading(true);
            
            try {
                switch(page) {
                    case 'dashboard':
                        await loadDashboard();
                        break;
                    case 'users':
                        await loadUsers();
                        break;
                    case 'partners':
                        await loadPartners();
                        break;
                    case 'customers':
                        await loadCustomers();
                        break;
                    case 'requests':
                        await loadRequests();
                        break;
                    case 'earnings':
                        await loadEarnings();
                        break;
                    case 'online':
                        await loadOnlinePartners();
                        break;
                    case 'pending':
                        await loadPendingApprovals();
                        break;
                    case 'rejected':
                        await loadRejectedPartners();
                        break;
                    case 'documents':
                        await loadDocumentVerification();
                        break;
                }
            } catch (error) {
                console.error(`Error loading ${page}:`, error);
                showToast(`Failed to load ${page} data`, 'error');
            } finally {
                setLoading(false);
            }
        }

        // ========== USER ACTIONS ==========
        async function viewUserDetails(userId) {
            try {
                const users = await apiRequest('/admin/users?limit=100');
                if (!users?.success) return;
                
                const user = users.data.users.find(u => u.id === userId);
                if (!user) {
                    showToast('User not found', 'error');
                    return;
                }
                
                document.getElementById('modalTitle').textContent = `${user.full_name || 'User'} Details`;
                
                const modalBody = document.getElementById('modalBody');
                const modalFooter = document.getElementById('modalFooter');
                
                const userType = user.user_type || 'customer';
                const isActive = user.is_active !== false;
                const isOnline = user.is_online === true;
                const isRejected = user.rejection_reason !== null;
                
                let statusText = '';
                if (userType === 'delivery') {
                    if (isActive) statusText = '<span class="status-badge status-active">‚úÖ Active</span>';
                    else if (isRejected) statusText = '<span class="status-badge status-rejected">‚ùå Rejected</span>';
                    else statusText = '<span class="status-badge status-pending">‚è≥ Pending</span>';
                } else {
                    statusText = isActive ? 
                        '<span class="status-badge status-active">‚úÖ Active</span>' : 
                        '<span class="status-badge status-inactive">‚ö´ Inactive</span>';
                }
                
                modalBody.innerHTML = `
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">Full Name</span>
                            <div class="detail-value">${user.full_name || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Phone Number</span>
                            <div class="detail-value">${user.phone || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Email Address</span>
                            <div class="detail-value">${user.email || 'No email'}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">User Type</span>
                            <div class="detail-value">
                                ${userType === 'admin' ? 'üëë Admin' : 
                                  userType === 'delivery' ? 'üöö Delivery Partner' : 
                                  'üë§ Customer'}
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Account Status</span>
                            <div class="detail-value">${statusText}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Online Status</span>
                            <div class="detail-value">
                                ${isOnline ? 
                                    '<span class="status-badge status-online">üü¢ Online</span>' : 
                                    '<span class="status-badge status-offline">‚ö´ Offline</span>'}
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Profile Photo</span>
                            <div class="detail-value">
                                ${user.profile_image_url && user.profile_image_url !== 'null' ? 
                                    `<img src="${user.profile_image_url}" alt="Profile" style="max-width: 100px; border-radius: 8px;">` : 
                                    'No photo'}
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Registration Date</span>
                            <div class="detail-value">${formatDate(user.created_at)}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Last Updated</span>
                            <div class="detail-value">${formatTimeAgo(user.updated_at)}</div>
                        </div>
                    </div>
                    
                    ${userType === 'delivery' ? `
                        <div class="mt-3">
                            <h3 style="margin-bottom: 16px;">Partner Details</h3>
                            <div class="details-grid">
                                <div class="detail-item">
                                    <span class="detail-label">NID Number</span>
                                    <div class="detail-value">${user.nid_number || 'N/A'}</div>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">NID Documents</span>
                                    <div class="detail-value">
                                        ${user.nid_front_image_url && user.nid_front_image_url !== 'null' ? 
                                            `<a href="${user.nid_front_image_url}" target="_blank">Front</a>` : 'No front'} | 
                                        ${user.nid_back_image_url && user.nid_back_image_url !== 'null' ? 
                                            `<a href="${user.nid_back_image_url}" target="_blank">Back</a>` : 'No back'}
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Emergency Contact</span>
                                    <div class="detail-value">
                                        ${user.emergency_contact_name || 'N/A'} 
                                        (${user.emergency_contact_relationship || 'N/A'})<br>
                                        <small>${user.emergency_contact_phone || 'No phone'}</small>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Address</span>
                                    <div class="detail-value">${user.address || 'N/A'}</div>
                                </div>
                                ${user.rejection_reason ? `
                                <div class="detail-item">
                                    <span class="detail-label" style="color: var(--danger);">Rejection Reason</span>
                                    <div class="detail-value" style="color: var(--danger);">
                                        ‚ùå ${user.rejection_reason}<br>
                                        <small>Rejected on: ${formatDateTime(user.rejected_at)}</small>
                                    </div>
                                </div>
                                ` : ''}
                                ${user.latitude && user.longitude ? `
                                <div class="detail-item">
                                    <span class="detail-label">GPS Location</span>
                                    <div class="detail-value">
                                        Latitude: ${user.latitude}<br>
                                        Longitude: ${user.longitude}<br>
                                        <small>Last updated: ${formatTimeAgo(user.last_location_update)}</small>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                `;
                
                modalFooter.innerHTML = `
                    ${userType === 'delivery' && !isActive && !isRejected ? 
                        `<button class="btn btn-success" onclick="approvePartner(${user.id}, true)">
                            ‚úì Approve Partner
                        </button>
                        <button class="btn btn-danger" onclick="openRejectModal(${user.id})">
                            ‚úó Reject Partner
                        </button>` : ''}
                    ${isActive ? 
                        `<button class="btn btn-warning" onclick="deactivateUser(${user.id}, true)">
                            ‚úó Deactivate
                        </button>` : ''}
                    <button class="btn btn-secondary" onclick="document.getElementById('userModal').classList.remove('show')">
                        Close
                    </button>
                `;
                
                document.getElementById('userModal').classList.add('show');
                
            } catch (error) {
                console.error('Error viewing user:', error);
                showToast('Failed to load user details', 'error');
            }
        }

        async function viewPartnerDetails(userId) {
            await viewUserDetails(userId);
        }

        async function viewPartnerDocuments(userId) {
            try {
                const users = await apiRequest('/admin/users?limit=100');
                if (!users?.success) return;
                
                const partner = users.data.users.find(u => u.id === userId && u.user_type === 'delivery');
                if (!partner) {
                    showToast('Partner not found', 'error');
                    return;
                }
                
                document.getElementById('documentsTitle').textContent = `${partner.full_name || 'Partner'} Documents`;
                
                const hasProfile = partner.profile_image_url && partner.profile_image_url !== 'null';
                const hasNidFront = partner.nid_front_image_url && partner.nid_front_image_url !== 'null';
                const hasNidBack = partner.nid_back_image_url && partner.nid_back_image_url !== 'null';
                
                const documentsBody = document.getElementById('documentsBody');
                const documentsFooter = document.getElementById('documentsFooter');
                
                documentsBody.innerHTML = `
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">Partner Name</span>
                            <div class="detail-value">${partner.full_name || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Phone Number</span>
                            <div class="detail-value">${partner.phone || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">NID Number</span>
                            <div class="detail-value">${partner.nid_number || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Emergency Contact</span>
                            <div class="detail-value">
                                ${partner.emergency_contact_name || 'N/A'} (${partner.emergency_contact_relationship || 'N/A'})<br>
                                <small>${partner.emergency_contact_phone || 'No phone'}</small>
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Address</span>
                            <div class="detail-value">${partner.address || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Verification Status</span>
                            <div class="detail-value">
                                ${partner.is_active ? 
                                    '<span class="status-badge status-active">‚úÖ Approved</span>' : 
                                    partner.rejection_reason ?
                                    '<span class="status-badge status-rejected">‚ùå Rejected</span>' :
                                    '<span class="status-badge status-pending">‚è≥ Pending</span>'}
                            </div>
                        </div>
                        ${partner.rejection_reason ? `
                        <div class="detail-item">
                            <span class="detail-label" style="color: var(--danger);">Rejection Reason</span>
                            <div class="detail-value" style="color: var(--danger);">
                                ‚ùå ${partner.rejection_reason}<br>
                                <small>Rejected on: ${formatDateTime(partner.rejected_at)}</small>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="mt-3">
                        <h3 style="margin-bottom: 16px;">Document Review</h3>
                        <div class="d-flex flex-column gap-3">
                            ${hasProfile ? `
                                <div class="detail-item">
                                    <span class="detail-label">Profile Photo</span>
                                    <div class="detail-value">
                                        <img src="${partner.profile_image_url}" alt="Profile Photo" style="max-width: 200px; border-radius: 8px; margin-bottom: 10px;">
                                        <br>
                                        <a href="${partner.profile_image_url}" target="_blank" class="btn btn-outline btn-sm">
                                            üîó Open Full Size
                                        </a>
                                    </div>
                                </div>
                            ` : '<div class="alert alert-warning">‚ùå No profile photo uploaded</div>'}
                            
                            ${hasNidFront ? `
                                <div class="detail-item">
                                    <span class="detail-label">NID Front</span>
                                    <div class="detail-value">
                                        <img src="${partner.nid_front_image_url}" alt="NID Front" style="max-width: 200px; border-radius: 8px; margin-bottom: 10px;">
                                        <br>
                                        <a href="${partner.nid_front_image_url}" target="_blank" class="btn btn-outline btn-sm">
                                            üîó Open Full Size
                                        </a>
                                    </div>
                                </div>
                            ` : '<div class="alert alert-warning">‚ùå No NID front uploaded</div>'}
                            
                            ${hasNidBack ? `
                                <div class="detail-item">
                                    <span class="detail-label">NID Back</span>
                                    <div class="detail-value">
                                        <img src="${partner.nid_back_image_url}" alt="NID Back" style="max-width: 200px; border-radius: 8px; margin-bottom: 10px;">
                                        <br>
                                        <a href="${partner.nid_back_image_url}" target="_blank" class="btn btn-outline btn-sm">
                                            üîó Open Full Size
                                        </a>
                                    </div>
                                </div>
                            ` : '<div class="alert alert-warning">‚ùå No NID back uploaded</div>'}
                        </div>
                    </div>
                `;
                
                documentsFooter.innerHTML = `
                    ${!partner.is_active && !partner.rejection_reason ? `
                        <button class="btn btn-success" onclick="approvePartner(${partner.id}, true)">
                            ‚úì Approve Partner
                        </button>
                        <button class="btn btn-danger" onclick="openRejectModal(${partner.id})">
                            ‚úó Reject Partner
                        </button>
                    ` : ''}
                    <button class="btn btn-secondary" onclick="document.getElementById('documentsModal').classList.remove('show')">
                        Close
                    </button>
                `;
                
                document.getElementById('documentsModal').classList.add('show');
                
            } catch (error) {
                console.error('Error viewing partner documents:', error);
                showToast('Failed to load documents', 'error');
            }
        }

        async function viewRequestDetails(requestId) {
            try {
                const requests = await apiRequest('/admin/requests?limit=200');
                if (!requests?.success) return;
                
                const request = requests.data.requests.find(r => r.id === requestId);
                if (!request) {
                    showToast('Request not found', 'error');
                    return;
                }
                
                document.getElementById('requestTitle').textContent = `Request ${request.request_number}`;
                
                const requestBody = document.getElementById('requestBody');
                requestBody.innerHTML = `
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">Request Number</span>
                            <div class="detail-value">${request.request_number}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status</span>
                            <div class="detail-value">
                                ${request.request_status === 'completed' ? 
                                    '<span class="status-badge status-completed">‚úÖ Completed</span>' :
                                    request.request_status === 'cancelled' ?
                                    '<span class="status-badge status-inactive">‚ùå Cancelled</span>' :
                                    '<span class="status-badge status-pending">‚è≥ Pending</span>'}
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Customer</span>
                            <div class="detail-value">
                                <div class="user-cell">
                                    <div class="avatar">
                                        ${request.customer?.profile_image_url ? 
                                            `<img src="${request.customer.profile_image_url}" alt="${request.customer.full_name}">` : 
                                            getInitials(request.customer?.full_name)}
                                    </div>
                                    <div class="user-info">
                                        <div class="user-name">${request.customer?.full_name || 'Unknown'}</div>
                                        <div class="user-email">${request.customer?.phone || ''}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Delivery Partner</span>
                            <div class="detail-value">
                                ${request.footman ? `
                                    <div class="user-cell">
                                        <div class="avatar">
                                            ${request.footman.profile_image_url ? 
                                                `<img src="${request.footman.profile_image_url}" alt="${request.footman.full_name}">` : 
                                                getInitials(request.footman.full_name)}
                                        </div>
                                        <div class="user-info">
                                            <div class="user-name">${request.footman.full_name}</div>
                                            <div class="user-email">${request.footman.phone}</div>
                                        </div>
                                    </div>
                                ` : 'Not assigned'}
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Total Amount</span>
                            <div class="detail-value">${formatCurrency(request.base_price)}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Your Commission (10%)</span>
                            <div class="detail-value">${formatCurrency(request.commission)}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Partner Earnings (90%)</span>
                            <div class="detail-value">${formatCurrency(request.footman_earnings)}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Payment Method</span>
                            <div class="detail-value">
                                ${request.customer_selected_payment ? 
                                    `<span class="status-badge">${request.customer_selected_payment.charAt(0).toUpperCase() + request.customer_selected_payment.slice(1)}</span>` : 
                                    'Not selected'}
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Created</span>
                            <div class="detail-value">${formatDateTime(request.created_at)}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Completed</span>
                            <div class="detail-value">${request.completed_at ? formatDateTime(request.completed_at) : 'Not completed'}</div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h3 style="margin-bottom: 16px;">Location Details</h3>
                        <div class="details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Pickup Location</span>
                                <div class="detail-value">
                                    Latitude: ${request.pickup_lat}<br>
                                    Longitude: ${request.pickup_lng}
                                </div>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Distance</span>
                                <div class="detail-value">${request.distance_km} KM</div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('requestFooter').innerHTML = `
                    <button class="btn btn-secondary" onclick="document.getElementById('requestModal').classList.remove('show')">
                        Close
                    </button>
                `;
                
                document.getElementById('requestModal').classList.add('show');
                
            } catch (error) {
                console.error('Error viewing request:', error);
                showToast('Failed to load request details', 'error');
            }
        }

        // ========== NEW: REJECT PARTNER WITH REASON ==========
        function openRejectModal(userId) {
            State.pendingRejectId = userId;
            document.getElementById('rejectReasonInput').value = '';
            document.getElementById('rejectReasonModal').classList.add('show');
        }

        async function rejectPartnerWithReason(userId, reason) {
            try {
                setLoading(true);
                
                const result = await apiRequest(`/admin/partners/${userId}/reject`, {
                    method: 'PUT',
                    body: JSON.stringify({ reason: reason })
                });
                
                if (result?.success) {
                    showToast('Partner rejected successfully! Reason sent via push notification.', 'success');
                    
                    // Close any open modals
                    document.getElementById('userModal').classList.remove('show');
                    document.getElementById('documentsModal').classList.remove('show');
                    
                    // Refresh current page
                    loadPageData(State.currentPage);
                    
                    // Refresh badges
                    const dashboardData = await apiRequest('/admin/dashboard');
                    if (dashboardData?.success) {
                        document.getElementById('pendingBadge').textContent = dashboardData.data.stats.pending_approvals || 0;
                        document.getElementById('rejectedBadge').textContent = dashboardData.data.stats.rejected_partners || 0;
                    }
                } else {
                    throw new Error(result?.message || 'Failed to reject partner');
                }
            } catch (error) {
                console.error('Reject partner error:', error);
                showToast(`Failed to reject partner: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        }

        // ========== APPROVE PARTNER ==========
        async function approvePartner(userId, fromModal = false) {
            if (!confirm('Are you sure you want to approve this partner?')) return;
            
            try {
                setLoading(true);
                
                const result = await apiRequest(`/admin/partners/${userId}/approve`, {
                    method: 'PUT'
                });
                
                if (result?.success) {
                    showToast('Partner approved successfully! Push notification sent.', 'success');
                    
                    if (fromModal) {
                        document.getElementById('userModal').classList.remove('show');
                        document.getElementById('documentsModal').classList.remove('show');
                    }
                    
                    // Refresh current page
                    loadPageData(State.currentPage);
                    
                    // Refresh badges
                    const dashboardData = await apiRequest('/admin/dashboard');
                    if (dashboardData?.success) {
                        document.getElementById('pendingBadge').textContent = dashboardData.data.stats.pending_approvals || 0;
                    }
                } else {
                    throw new Error(result?.message || 'Failed to approve partner');
                }
            } catch (error) {
                console.error('Approve partner error:', error);
                showToast(`Failed to approve partner: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        }

        async function deactivateUser(userId, fromModal = false) {
            if (!confirm('Are you sure you want to deactivate this user?')) return;
            
            try {
                const result = await apiRequest(`/admin/users/${userId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ is_active: false })
                });
                
                if (result?.success) {
                    showToast('User deactivated successfully!', 'success');
                    if (fromModal) {
                        document.getElementById('userModal').classList.remove('show');
                    }
                    loadPageData(State.currentPage);
                }
            } catch (error) {
                showToast(`Failed to deactivate user: ${error.message}`, 'error');
            }
        }

        // ========== INITIALIZATION ==========
        function initApp() {
            initTheme();
            initTheme();
            setupNavigation();
            updateAdminInfo();
            loadDashboard();
            
            // Initialize charts
            initRevenueChart();
            initRequestsChart();
            
            // Initialize map when Google Maps loads
            window.initMap = initMap;
            
            // Set up auto-refresh for dashboard
            setInterval(() => {
                if (State.currentPage === 'dashboard') {
                    loadDashboard();
                }
            }, Config.REFRESH_INTERVAL);
        }

        function updateAdminInfo() {
            if (State.currentUser) {
                const avatar = getInitials(State.currentUser.full_name || 'Admin');
                document.getElementById('adminAvatar').textContent = avatar;
                document.getElementById('topbarAvatar').textContent = avatar;
                document.getElementById('loginPhone').value = State.currentUser.phone || '01700000000';
            }
        }

        // Attach login button immediately when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                loginBtn.addEventListener('click', () => {
                    const phone = document.getElementById('loginPhone').value;
                    const password = document.getElementById('loginPassword').value;
                    if (!phone || !password) {
                        const errorDisplay = document.getElementById('loginError');
                        errorDisplay.textContent = 'Please enter phone and password';
                        errorDisplay.style.display = 'block';
                        return;
                    }
                    login(phone, password);
                });
                
                document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        loginBtn.click();
                    }
                });
            }
        });
        
        // Start the application
        document.addEventListener('DOMContentLoaded', initAuth);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOOTMAN - Admin Dashboard</title>
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --sidebar: #1e293b;
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #f1f5f9;
            color: var(--dark);
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--sidebar);
            color: white;
            padding: 20px 0;
        }

        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .logo h2 {
            color: white;
            font-size: 22px;
        }

        .logo span {
            font-size: 12px;
            opacity: 0.7;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            transition: all 0.3s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 15px;
            cursor: pointer;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .topbar {
            background: white;
            padding: 15px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: var(--secondary);
            margin-bottom: 30px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
        }

        .stat-card h3 {
            font-size: 14px;
            color: var(--secondary);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        /* Tables */
        .data-card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8fafc;
            padding: 15px 20px;
            text-align: left;
            font-weight: 600;
            color: var(--secondary);
            border-bottom: 1px solid #e2e8f0;
        }

        td {
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        tr:hover {
            background: #f8fafc;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--secondary);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--secondary);
        }

        /* Utility */
        .d-none { display: none !important; }
        .d-flex { display: flex; }
        .gap-2 { gap: 12px; }
        .ml-auto { margin-left: auto; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h2>FOOTMAN</h2>
                <span>Admin Panel</span>
            </div>

            <nav>
                <button class="nav-item active" data-page="dashboard">
                    üìä Dashboard
                </button>
                <button class="nav-item" data-page="users">
                    üë• All Users
                    <span class="badge badge-info ml-auto" id="usersCountBadge">15</span>
                </button>
                <button class="nav-item" data-page="requests">
                    üì¶ Delivery Requests
                    <span class="badge badge-warning ml-auto" id="requestsCountBadge">182</span>
                </button>
                <button class="nav-item" data-page="delivery">
                    üöö Delivery Partners
                </button>
                <button class="nav-item" data-page="customers">
                    üë§ Customers
                </button>
            </nav>

            <div style="padding: 20px; margin-top: auto;">
                <button class="btn btn-primary" id="logoutBtn" style="width: 100%;">
                    üö™ Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="topbar">
                <div>
                    <h3>Welcome, Admin</h3>
                    <small id="currentTime"></small>
                </div>
                <button class="btn btn-primary" id="refreshBtn">
                    üîÑ Refresh
                </button>
            </header>

            <!-- Content Area -->
            <div class="content">
                <!-- Dashboard -->
                <section id="dashboardPage">
                    <h1 class="page-title">Dashboard</h1>
                    <p class="page-subtitle">Overview of your delivery business</p>

                    <!-- Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Total Users</h3>
                            <div class="stat-value" id="totalUsers">15</div>
                            <small>In system</small>
                        </div>
                        <div class="stat-card">
                            <h3>Delivery Requests</h3>
                            <div class="stat-value" id="totalRequests">182</div>
                            <small>All-time requests</small>
                        </div>
                        <div class="stat-card">
                            <h3>Delivery Partners</h3>
                            <div class="stat-value" id="deliveryPartners">0</div>
                            <small>Active delivery boys</small>
                        </div>
                        <div class="stat-card">
                            <h3>Customers</h3>
                            <div class="stat-value" id="totalCustomers">0</div>
                            <small>Registered customers</small>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="data-card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Activity</h3>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>User</th>
                                        <th>Activity</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="activityTable">
                                    <tr>
                                        <td colspan="4" class="loading">Loading activity...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- All Users -->
                <section id="usersPage" class="d-none">
                    <h1 class="page-title">All Users</h1>
                    <p class="page-subtitle">Manage all users in the system</p>

                    <div class="data-card">
                        <div class="card-header">
                            <h3 class="card-title">Users List</h3>
                            <div class="d-flex gap-2">
                                <input type="text" placeholder="Search users..." id="userSearch" style="padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;">
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Phone</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable">
                                    <tr>
                                        <td colspan="6" class="loading">Loading users...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Delivery Requests -->
                <section id="requestsPage" class="d-none">
                    <h1 class="page-title">Delivery Requests</h1>
                    <p class="page-subtitle">Manage all delivery requests</p>

                    <div class="data-card">
                        <div class="card-header">
                            <h3 class="card-title">Requests List</h3>
                            <div class="d-flex gap-2">
                                <select id="requestStatusFilter" style="padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="accepted">Accepted</option>
                                    <option value="ongoing">Ongoing</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Request #</th>
                                        <th>Customer</th>
                                        <th>Footman</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="requestsTable">
                                    <tr>
                                        <td colspan="6" class="loading">Loading requests...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Delivery Partners -->
                <section id="deliveryPage" class="d-none">
                    <h1 class="page-title">Delivery Partners</h1>
                    <p class="page-subtitle">Manage delivery partners (footmen)</p>

                    <div class="data-card">
                        <div class="card-header">
                            <h3 class="card-title">Delivery Partners List</h3>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Phone</th>
                                        <th>NID</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="deliveryTable">
                                    <tr>
                                        <td colspan="6" class="loading">Loading delivery partners...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Customers -->
                <section id="customersPage" class="d-none">
                    <h1 class="page-title">Customers</h1>
                    <p class="page-subtitle">Manage customer accounts</p>

                    <div class="data-card">
                        <div class="card-header">
                            <h3 class="card-title">Customers List</h3>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Phone</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="customersTable">
                                    <tr>
                                        <td colspan="6" class="loading">Loading customers...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        // Configuration
        const API_BASE = 'https://footman-backend.onrender.com/api/v1';
        let currentToken = null;

        // Get token from URL
        function getTokenFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token');
        }

        // Check authentication
        function checkAuth() {
            currentToken = getTokenFromURL();
            if (!currentToken) {
                window.location.href = 'admin-login.html';
                return false;
            }
            return true;
        }

        // API Request
        async function apiRequest(endpoint, options = {}) {
            if (!currentToken) {
                window.location.href = 'admin-login.html';
                return;
            }

            const url = `${API_BASE}${endpoint}`;
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${currentToken}`,
                ...options.headers
            };

            try {
                const response = await fetch(url, { ...options, headers });
                if (response.status === 401) {
                    window.location.href = 'admin-login.html';
                    return;
                }
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                alert('API Error: ' + error.message);
            }
        }

        // Navigation
        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    const page = btn.dataset.page;
                    switchPage(page);
                });
            });

            document.getElementById('logoutBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to logout?')) {
                    window.location.href = 'admin-login.html';
                }
            });

            document.getElementById('refreshBtn').addEventListener('click', () => {
                loadCurrentPage();
            });

            // Update time
            function updateTime() {
                const now = new Date();
                document.getElementById('currentTime').textContent = 
                    now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
            }
            updateTime();
            setInterval(updateTime, 1000);
        }

        function switchPage(page) {
            // Update active nav
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.page === page);
            });

            // Show/hide pages
            document.querySelectorAll('section[id$="Page"]').forEach(section => {
                section.classList.toggle('d-none', section.id !== page + 'Page');
            });

            loadCurrentPage();
        }

        function loadCurrentPage() {
            const activePage = document.querySelector('.nav-item.active').dataset.page;
            
            switch(activePage) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'requests':
                    loadRequests();
                    break;
                case 'delivery':
                    loadDeliveryPartners();
                    break;
                case 'customers':
                    loadCustomers();
                    break;
            }
        }

        // Dashboard
        async function loadDashboard() {
            try {
                // Load users count
                const usersResult = await apiRequest('/admin/users?limit=1');
                if (usersResult?.success) {
                    const totalUsers = usersResult.data.pagination?.total || 0;
                    document.getElementById('totalUsers').textContent = totalUsers;
                    document.getElementById('usersCountBadge').textContent = totalUsers;
                    
                    // Count delivery partners and customers
                    const allUsers = await apiRequest('/admin/users?limit=100');
                    if (allUsers?.success) {
                        const deliveryCount = allUsers.data.users.filter(u => u.user_type === 'delivery').length;
                        const customerCount = allUsers.data.users.filter(u => u.user_type === 'customer').length;
                        
                        document.getElementById('deliveryPartners').textContent = deliveryCount;
                        document.getElementById('totalCustomers').textContent = customerCount;
                    }
                }

                // Load activity (simulated)
                const activityTable = document.getElementById('activityTable');
                activityTable.innerHTML = `
                    <tr>
                        <td>Just now</td>
                        <td>System Administrator</td>
                        <td>Logged into admin panel</td>
                        <td><span class="badge badge-success">Success</span></td>
                    </tr>
                    <tr>
                        <td>5 min ago</td>
                        <td>Customer (017xxxxxx)</td>
                        <td>Created delivery request</td>
                        <td><span class="badge badge-info">Pending</span></td>
                    </tr>
                    <tr>
                        <td>1 hour ago</td>
                        <td>Delivery Partner</td>
                        <td>Completed delivery</td>
                        <td><span class="badge badge-success">Completed</span></td>
                    </tr>
                `;

            } catch (error) {
                console.error('Dashboard error:', error);
            }
        }

        // Users Management
        async function loadUsers() {
            try {
                const result = await apiRequest('/admin/users?limit=100');
                if (result?.success) {
                    renderUsersTable(result.data.users);
                }
            } catch (error) {
                console.error('Users error:', error);
            }
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                
                let statusBadge = user.is_active ? 
                    '<span class="badge badge-success">Active</span>' : 
                    '<span class="badge badge-warning">Inactive</span>';
                
                let typeBadge = '';
                switch(user.user_type) {
                    case 'admin':
                        typeBadge = '<span class="badge badge-danger">Admin</span>';
                        break;
                    case 'delivery':
                        typeBadge = '<span class="badge badge-info">Delivery</span>';
                        break;
                    case 'customer':
                        typeBadge = '<span class="badge badge-success">Customer</span>';
                        break;
                }

                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.full_name || 'N/A'}</td>
                    <td>${user.phone}</td>
                    <td>${typeBadge}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewUser(${user.id})">
                            üëÅÔ∏è View
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Requests Management
        async function loadRequests() {
            // Simulated for now - your backend needs /admin/requests endpoint
            const requestsTable = document.getElementById('requestsTable');
            requestsTable.innerHTML = `
                <tr>
                    <td colspan="6" class="empty-state">
                        ‚ö†Ô∏è Requests endpoint not implemented in backend yet<br>
                        <small>You have 182 requests in database (from check)</small>
                    </td>
                </tr>
            `;
            
            // Update count badge
            document.getElementById('requestsCountBadge').textContent = '182';
        }

        // Delivery Partners
        async function loadDeliveryPartners() {
            try {
                const result = await apiRequest('/admin/users?user_type=delivery&limit=100');
                if (result?.success) {
                    renderDeliveryTable(result.data.users);
                }
            } catch (error) {
                console.error('Delivery partners error:', error);
            }
        }

        function renderDeliveryTable(partners) {
            const tbody = document.getElementById('deliveryTable');
            tbody.innerHTML = '';

            if (partners.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            No delivery partners found
                        </td>
                    </tr>
                `;
                return;
            }

            partners.forEach(partner => {
                const row = document.createElement('tr');
                
                let statusBadge = partner.is_active ? 
                    '<span class="badge badge-success">Active</span>' : 
                    '<span class="badge badge-warning">Pending</span>';
                
                row.innerHTML = `
                    <td>${partner.id}</td>
                    <td>${partner.full_name || 'N/A'}</td>
                    <td>${partner.phone}</td>
                    <td>${partner.nid_number || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewUser(${partner.id})">
                            üëÅÔ∏è View
                        </button>
                        ${!partner.is_active ? `
                            <button class="btn btn-success btn-sm" onclick="approveUser(${partner.id})">
                                ‚úì Approve
                            </button>
                        ` : ''}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Customers
        async function loadCustomers() {
            try {
                const result = await apiRequest('/admin/users?user_type=customer&limit=100');
                if (result?.success) {
                    renderCustomersTable(result.data.users);
                }
            } catch (error) {
                console.error('Customers error:', error);
            }
        }

        function renderCustomersTable(customers) {
            const tbody = document.getElementById('customersTable');
            tbody.innerHTML = '';

            customers.forEach(customer => {
                const row = document.createElement('tr');
                
                let statusBadge = customer.is_active ? 
                    '<span class="badge badge-success">Active</span>' : 
                    '<span class="badge badge-danger">Inactive</span>';
                
                row.innerHTML = `
                    <td>${customer.id}</td>
                    <td>${customer.full_name || 'N/A'}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.email || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewUser(${customer.id})">
                            üëÅÔ∏è View
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // User Actions
        async function viewUser(userId) {
            alert(`View user ${userId} - To be implemented`);
        }

        async function approveUser(userId) {
            if (confirm('Approve this delivery partner?')) {
                try {
                    const result = await apiRequest(`/admin/users/${userId}/status`, {
                        method: 'PUT',
                        body: JSON.stringify({ is_active: true })
                    });
                    
                    if (result?.success) {
                        alert('User approved successfully!');
                        loadCurrentPage();
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }

        // Search functionality
        document.getElementById('userSearch')?.addEventListener('input', debounce(async (e) => {
            const search = e.target.value;
            if (search.length >= 2) {
                // Implement search
            }
        }, 500));

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                setupNavigation();
                loadDashboard();
            }
        });
    </script>
</body>
</html>
